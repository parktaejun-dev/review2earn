// ============================================
// Review2Earn (ë¦¬ë·°íˆ¬ì–¸) v3.1
// Prisma Schema - MVP í•µì‹¬ ê¸°ëŠ¥ ì¶”ê°€
// Last Updated: 2025-10-09
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. ì‡¼í•‘ëª° ì„¤ì • (OAuth + ìš´ì˜ ì •ë³´ í†µí•©)
// ============================================
model MallSettings {
  id     Int    @id @default(autoincrement())
  mallId String @unique @map("mall_id")

  // OAuth í† í° ì •ë³´
  accessToken    String?   @map("access_token")
  refreshToken   String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")
  scopes         String?

  // v3.0 ë³´ìƒ ìš”ìœ¨
  reviewerRewardRate Float @default(0.01) @map("reviewer_reward_rate")
  buyerDiscountRate  Float @default(0.05) @map("buyer_discount_rate")
  platformFeeRate    Float @default(0.005) @map("platform_fee_rate")

  // ìš´ì˜ ì •ë³´
  isActive Boolean @default(true) @map("is_active")

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  consents     Consent[]
  reviews      Review[]
  transactions Transaction[]

  @@map("mall_settings")
}

// ============================================
// 2. ì‚¬ìš©ì ë™ì˜ ì •ë³´
// ============================================
model Consent {
  id       Int    @id @default(autoincrement())
  memberId String @map("member_id")
  mallId   String @map("mall_id")

  // ë™ì˜ ì •ë³´
  consented   Boolean   @default(false)
  consentedAt DateTime? @map("consented_at")

  // ë³´ì•ˆ/ì¶”ì 
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mall    MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  reviews Review[]

  @@unique([memberId, mallId])
  @@index([memberId, mallId])
  @@map("consents")
}

// ============================================
// 3. ë¦¬ë·° ì •ë³´ (ì¶”ì²œ ì½”ë“œ í¬í•¨)
// ============================================
model Review {
  id Int @id @default(autoincrement())

  // Cafe24 ì—°ë™ ì •ë³´
  cafe24BoardNo Int @map("cafe24_board_no")
  productNo     Int @map("product_no")

  // íšŒì› ì •ë³´
  memberId String @map("member_id")
  mallId   String @map("mall_id")

  // ë¦¬ë·° ë‚´ìš©
  content String? @db.Text
  rating  Int?

  // ğŸ†• v3.1: ì¶”ì²œ ë§í¬ í†µê³„ ì¶”ê°€
  referralCode    String  @unique @map("referral_code")
  participateR2e  Boolean @default(true) @map("participate_r2e")
  clickCount      Int     @default(0) @map("click_count")
  conversionCount Int     @default(0) @map("conversion_count")
  totalRevenue    Float   @default(0) @map("total_revenue")

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mall         MallSettings  @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  consent      Consent       @relation(fields: [memberId, mallId], references: [memberId, mallId], onDelete: Restrict)
  transactions Transaction[]

  @@unique([cafe24BoardNo, mallId])
  @@unique([referralCode, mallId])
  @@index([productNo, mallId])
  @@index([memberId])
  @@index([referralCode])
  @@map("reviews")
}

// ============================================
// 4. ê±°ë˜ ê¸°ë¡ (ì¶”ì²œ êµ¬ë§¤ + ë³´ìƒ)
// ============================================
model Transaction {
  id            Int      @id @default(autoincrement())
  reviewId      Int      @map("review_id")
  mallId        String   @map("mall_id")
  cafe24OrderId String   @map("cafe24_order_id")
  productNo     Int      @map("product_no")
  orderAmount   Float    @map("order_amount")
  rewardAmount  Float    @map("reward_amount")
  rewardRate    Float    @map("reward_rate")
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  review Review       @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  mall   MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)

  @@index([reviewId])
  @@index([mallId])
  @@index([cafe24OrderId])
  @@index([mallId, createdAt])
  @@map("transactions")
}

// ============================================
// 5. ìƒí’ˆë³„ ì»¤ìŠ¤í…€ ë³´ìƒ ìš”ìœ¨
// ============================================
model ProductRewardRate {
  id        Int    @id @default(autoincrement())
  mallId    String @map("mall_id")
  productId String @map("product_id")

  reviewerRewardRate Float @default(0.015) @map("reviewer_reward_rate")
  buyerDiscountRate  Float @default(0.07) @map("buyer_discount_rate")
  platformFeeRate    Float @default(0.005) @map("platform_fee_rate")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([mallId, productId])
  @@index([mallId])
  @@index([productId])
  @@map("product_reward_rates")
}
