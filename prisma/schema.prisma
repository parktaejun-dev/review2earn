// ============================================
// Review2Earn (리뷰투언) v6.0
// Prisma Schema - 멀티몰 지원 + 익명 레퍼럴 코드
// Last Updated: 2025-10-11 20:12
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. 쇼핑몰 설정
// ============================================
model MallSettings {
  id     Int    @id @default(autoincrement())
  mallId String @unique @map("mall_id")

  // ✅ v6.0: ScriptTag 번호 (자동 버튼 생성용)
  scriptTagNo Int? @map("script_tag_no")

  // OAuth 토큰 정보
  accessToken    String?   @map("access_token")
  refreshToken   String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")
  scopes         String?

  // 보상 요율
  reviewerRewardRate Float @default(0.01) @map("reviewer_reward_rate") // 1%
  buyerDiscountRate  Float @default(0.01) @map("buyer_discount_rate")  // 1%
  platformFeeRate    Float @default(0.005) @map("platform_fee_rate")   // 0.5%

  // 예치금 시스템
  prepaidBalance      Int @default(0) @map("prepaid_balance")
  minBalanceThreshold Int @default(50000) @map("min_balance_threshold")

  // 법적 동의 타임스탬프
  consentServiceTerms DateTime? @map("consent_service_terms")
  consentPrivacy      DateTime? @map("consent_privacy")

  // 운영 정보
  isActive Boolean @default(true) @map("is_active")

  // 타임스탬프
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  reviews      Review[]
  transactions Transaction[]

  @@map("mall_settings")
}

// ============================================
// 2. R2E 통합 계정 (v6.0 개선)
// ============================================
model R2EAccount {
  id    String @id @default(cuid())
  email String @unique

  // ✅ v6.0: 익명화된 레퍼럴 코드 (모든 쇼핑몰 공통)
  referralCode String @unique @map("referral_code") // R2E-A7F3B2E1C9D4

  // 비밀번호 (선택)
  password String? // bcrypt 해시

  // 통합 포인트
  totalPoints     Int @default(0) @map("total_points")
  availablePoints Int @default(0) @map("available_points")

  // 개인정보
  phoneNumber String? @map("phone_number")
  ciValue     String? @unique @map("ci_value")

  // 약관 동의
  consentMarketing   Boolean @default(false) @map("consent_marketing")
  consentDataSharing Boolean @default(false) @map("consent_data_sharing")

  // 타임스탬프
  createdAt   DateTime  @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  reviews            Review[]
  r2eTransactions    R2ETransaction[]
  withdrawalRequests WithdrawalRequest[]
  mallLinks          R2EMallLink[] // ✅ v6.0: 멀티몰 연동

  @@index([email])
  @@index([referralCode])
  @@map("r2e_accounts")
}

// ============================================
// 3. ✅ v6.0 NEW: 멀티몰 연동 테이블
// ============================================
model R2EMallLink {
  id           String     @id @default(cuid())
  r2eAccountId String     @map("r2e_account_id")
  r2eAccount   R2EAccount @relation(fields: [r2eAccountId], references: [id], onDelete: Cascade)

  // 쇼핑몰 정보
  mallId       String  @map("mall_id")
  mallEmail    String? @map("mall_email")    // 쇼핑몰에서 사용하는 이메일 (다를 수 있음)
  mallMemberId String? @map("mall_member_id") // 쇼핑몰 회원 ID

  // 인증 상태
  isVerified Boolean @default(false) @map("is_verified")

  // 타임스탬프
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([r2eAccountId, mallId])
  @@index([mallId])
  @@index([r2eAccountId])
  @@map("r2e_mall_links")
}

// ============================================
// 4. 리뷰 정보 (v6.0 개선)
// ============================================
model Review {
  id Int @id @default(autoincrement())

  // Cafe24 연동 정보
  cafe24BoardNo Int    @map("cafe24_board_no")
  productNo     Int    @map("product_no")
  mallId        String @map("mall_id")

  // 회원 정보
  memberId    String  @map("member_id")
  memberEmail String? @map("member_email")
  r2eUserId   String? @map("r2e_user_id")

  // 리뷰 내용
  content String? @db.Text
  rating  Int?

  // ✅ v6.0: 익명화된 레퍼럴 코드
  referralCode String @map("referral_code") // R2E-A7F3B2E1C9D4

  // R2E 참여 및 통계
  participateR2e  Boolean @default(true) @map("participate_r2e")
  clickCount      Int     @default(0) @map("click_count")
  conversionCount Int     @default(0) @map("conversion_count")
  totalRevenue    Float   @default(0) @map("total_revenue")

  // 타임스탬프
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mall            MallSettings     @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  r2eUser         R2EAccount?      @relation(fields: [r2eUserId], references: [id])
  transactions    Transaction[]
  r2eTransactions R2ETransaction[]

  @@unique([cafe24BoardNo, mallId])
  @@index([mallId])
  @@index([productNo, mallId])
  @@index([memberId])
  @@index([memberEmail])
  @@index([referralCode])
  @@index([r2eUserId])
  @@map("reviews")
}

// ============================================
// 5. 기존 거래 기록 (v3.2 호환성 유지)
// ============================================
model Transaction {
  id            Int      @id @default(autoincrement())
  reviewId      Int      @map("review_id")
  mallId        String   @map("mall_id")
  cafe24OrderId String   @map("cafe24_order_id")
  productNo     Int      @map("product_no")
  orderAmount   Float    @map("order_amount")
  rewardAmount  Float    @map("reward_amount")
  rewardRate    Float    @map("reward_rate")
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  review Review       @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  mall   MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)

  @@index([reviewId])
  @@index([mallId])
  @@index([cafe24OrderId])
  @@index([mallId, createdAt])
  @@map("transactions")
}

// ============================================
// 6. R2E 포인트 거래 내역 (v6.0 개선)
// ============================================
model R2ETransaction {
  id        String @id @default(cuid())
  r2eUserId String @map("r2e_user_id")
  reviewId  Int?   @map("review_id")

  // ✅ v6.0: 멀티몰 지원
  mallId String @map("mall_id")

  // 거래 정보
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  amount      Int
  description String?           @db.Text

  // 연결 정보
  relatedOrderId  String? @map("related_order_id")
  relatedReviewId Int?    @map("related_review_id")
  referralCode    String  @map("referral_code")

  // 날짜 정보
  earnedAt       DateTime  @default(now()) @map("earned_at")
  settlementDate DateTime? @map("settlement_date")
  expiryDate     DateTime  @map("expiry_date")

  // Relations
  account R2EAccount @relation(fields: [r2eUserId], references: [id], onDelete: Cascade)
  review  Review?    @relation(fields: [reviewId], references: [id], onDelete: SetNull)

  @@index([r2eUserId])
  @@index([mallId])
  @@index([status])
  @@index([type])
  @@index([settlementDate])
  @@index([expiryDate])
  @@index([relatedOrderId])
  @@index([referralCode])
  @@map("r2e_transactions")
}

// ============================================
// Enums
// ============================================
enum TransactionStatus {
  PENDING
  COMPLETED
  CONFIRMED
  CANCELLED
  EXPIRED
  FAILED
}

enum TransactionType {
  REFERRAL_REWARD
  WITHDRAW
  EXPIRE
  ADJUSTMENT
}

// ============================================
// 7. 출금 요청
// ============================================
model WithdrawalRequest {
  id            String           @id @default(cuid())
  r2eUserId     String           @map("r2e_user_id")
  amount        Int
  bankName      String           @map("bank_name")
  accountNumber String           @map("account_number")
  accountHolder String           @map("account_holder")
  status        WithdrawalStatus @default(PENDING)
  requestedAt   DateTime         @default(now()) @map("requested_at")
  processedAt   DateTime?        @map("processed_at")
  adminNote     String?          @map("admin_note")

  // Relations
  account R2EAccount @relation(fields: [r2eUserId], references: [id], onDelete: Cascade)

  @@index([r2eUserId])
  @@index([status])
  @@map("withdrawal_requests")
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// ============================================
// 8. 알림 로그
// ============================================
model NotificationLog {
  id      String              @id @default(cuid())
  userId  String              @map("user_id")
  type    NotificationType
  channel NotificationChannel
  sentAt  DateTime            @default(now()) @map("sent_at")
  status  NotificationStatus  @default(SENT)
  content String              @db.Text

  @@index([userId])
  @@index([type])
  @@index([sentAt])
  @@map("notification_logs")
}

enum NotificationType {
  ACCOUNT_ACTIVATION
  POINT_EARNED
  POINT_EXPIRY_WARNING
  WITHDRAWAL_COMPLETED
  BALANCE_LOW
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  SENT
  FAILED
  OPENED
}

// ============================================
// 9. 상품별 커스텀 보상 요율
// ============================================
model ProductRewardRate {
  id        Int    @id @default(autoincrement())
  mallId    String @map("mall_id")
  productId String @map("product_id")

  reviewerRewardRate Float @default(0.01) @map("reviewer_reward_rate") // 1%
  buyerDiscountRate  Float @default(0.01) @map("buyer_discount_rate")  // 1%
  platformFeeRate    Float @default(0.005) @map("platform_fee_rate")   // 0.5%

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([mallId, productId])
  @@index([mallId])
  @@index([productId])
  @@map("product_reward_rates")
}

// ============================================
// 10. 인증 토큰
// ============================================
model AuthToken {
  id        Int      @id @default(autoincrement())
  email     String   @map("email")
  token     String   @unique @map("token")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false) @map("used")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@index([token])
  @@map("auth_tokens")
}
