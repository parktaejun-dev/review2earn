# ğŸ¯ Review2Earn (ë¦¬ë·°íˆ¬ì–¸) - ìµœì¢… ì„¤ê³„ ë¬¸ì„œ v4.0

**ë²„ì „:** 4.0 (Phase 1 OAuth + ScriptTags êµ¬í˜„ ì™„ë£Œ)  
**ì‘ì„±ì¼:** 2025ë…„ 10ì›” 8ì¼  
**í”„ë¡œì íŠ¸:** ì¹´í˜24 ê¸°ë°˜ ë¦¬ë·° ì¶”ì²œ êµ¬ë§¤ ìë™ ë³´ìƒ ì‹œìŠ¤í…œ  
**ì €ì¥ì†Œ:** https://github.com/parktaejun/review2earn  
**ë°°í¬ URL:** https://review2earn.vercel.app

---

## ğŸ“‹ ëª©ì°¨

1. [í”„ë¡œì íŠ¸ ê°œìš”](#1-í”„ë¡œì íŠ¸-ê°œìš”)
2. [í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš°](#2-í•µì‹¬-ë¹„ì¦ˆë‹ˆìŠ¤-í”Œë¡œìš°)
3. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#3-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
4. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#4-ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
5. [Phase 1 êµ¬í˜„ ì™„ë£Œ](#5-phase-1-êµ¬í˜„-ì™„ë£Œ)
6. [Phase 2 ê°œë°œ ê³„íš](#6-phase-2-ê°œë°œ-ê³„íš)
7. [Phase 3 ê°œë°œ ê³„íš](#7-phase-3-ê°œë°œ-ê³„íš)
8. [Phase 4 ê°œë°œ ê³„íš](#8-phase-4-ê°œë°œ-ê³„íš)
9. [API ëª…ì„¸](#9-api-ëª…ì„¸)
10. [ë³´ì•ˆ ë° ì„±ëŠ¥](#10-ë³´ì•ˆ-ë°-ì„±ëŠ¥)
11. [ë°°í¬ ë° ìš´ì˜](#11-ë°°í¬-ë°-ìš´ì˜)
12. [ê°œë°œ ì¼ì •](#12-ê°œë°œ-ì¼ì •)

---

## ğŸ“Œ 1. í”„ë¡œì íŠ¸ ê°œìš”

### 1.1 ëª©í‘œ

**ë¦¬ë·°íˆ¬ì–¸(Review2Earn)**ì€ ì¹´í˜24 ì‡¼í•‘ëª°ì—ì„œ ë¦¬ë·°ë¥¼ í†µí•œ êµ¬ë§¤ ì „í™˜ ì‹œ, ë¦¬ë·° ì‘ì„±ìì™€ êµ¬ë§¤ìì—ê²Œ ìë™ìœ¼ë¡œ ë³´ìƒì„ ì§€ê¸‰í•˜ëŠ” ì„±ê³¼í˜• ë§ˆì¼€íŒ… í”Œë«í¼ì…ë‹ˆë‹¤.

**í•µì‹¬ ì°¨ë³„ì :**
- âœ… ê´‘ê³ ë¹„ë¥¼ ì‚¬ì „ì— ì§€ë¶ˆí•˜ì§€ ì•ŠìŒ (ì„±ê³¼í˜• ê³¼ê¸ˆ)
- âœ… ë¦¬ë·° ì‘ì„±ìê°€ ë°˜ë³µì ìœ¼ë¡œ ìˆ˜ìµ ì°½ì¶œ ê°€ëŠ¥
- âœ… êµ¬ë§¤ìëŠ” ì‹ ë¢°ë„ ë†’ì€ ë¦¬ë·° ê¸°ë°˜ êµ¬ë§¤ ìœ ë„
- âœ… ì‡¼í•‘ëª°ì€ ì‹¤ì œ ë§¤ì¶œ ë°œìƒ ì‹œì—ë§Œ ë¹„ìš© ì§€ë¶ˆ

### 1.2 í•µì‹¬ ê°€ì¹˜ ì œì•ˆ

| ì°¸ì—¬ì | ê°€ì¹˜ ì œì•ˆ | ë³´ìƒ/ë¹„ìš© |
|--------|----------|----------|
| **ë¦¬ë·° ì‘ì„±ì (A)** | ì‘ì„±í•œ ë¦¬ë·°ë¥¼ í†µí•´ êµ¬ë§¤ ë°œìƒ ì‹œ ì§€ì†ì  ìˆ˜ìµ | êµ¬ë§¤ì•¡ì˜ **x%** ì ë¦½ê¸ˆ (ë¬´ì œí•œ ë°˜ë³µ) |
| **êµ¬ë§¤ì (B)** | ì‹ ë¢°ë„ ë†’ì€ ë¦¬ë·° ê¸°ë°˜ êµ¬ë§¤ ê²°ì • + í• ì¸ í˜œíƒ | **y%** í• ì¸ ì¿ í° ìë™ ë°œê¸‰ |
| **ì‡¼í•‘ëª° ìš´ì˜ì** | ì‹¤ì œ êµ¬ë§¤ ë°œìƒ ì‹œì—ë§Œ ë¹„ìš© ì§€ë¶ˆ (ì„±ê³¼í˜•) | **(x + y + z)%** ë¹„ìš© |
| **Review2Earn** | í”Œë«í¼ ìš´ì˜ ë° ê¸°ìˆ  ì œê³µ | **z = (x + y) Ã— 0.25%** ìˆ˜ìˆ˜ë£Œ |

---

### 1.3 ë³´ìƒ ë¹„ìœ¨ ì‹œìŠ¤í…œ (v3.0ì—ì„œ ë„ì…)

#### 1.3.1 ìë™ ê³„ì‚° ê³µì‹

```
í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) = (ë¦¬ë·° ì‘ì„±ì ë¹„ìœ¨(x) + êµ¬ë§¤ì í• ì¸(y)) Ã— 0.25

ì‡¼í•‘ëª° ì´ ë¶€ë‹´ = x + y + z
```

**ì˜ˆì‹œ:**
- x = 2%, y = 2% â†’ z = (2 + 2) Ã— 0.25 = **1%** â†’ ì´ ë¶€ë‹´ **5%**
- x = 5%, y = 5% â†’ z = (5 + 5) Ã— 0.25 = **2.5%** â†’ ì´ ë¶€ë‹´ **12.5%**

#### 1.3.2 ìµœì†Œ ìš”ìœ¨ ì œí•œ

| í•­ëª© | ìµœì†Œê°’ | ìµœëŒ€ê°’ | ê¸°ë³¸ê°’ |
|------|--------|--------|--------|
| ë¦¬ë·° ì‘ì„±ì ë¹„ìœ¨ (x) | 1% | ì œí•œì—†ìŒ | 1% |
| êµ¬ë§¤ì í• ì¸ (y) | 1% | ì œí•œì—†ìŒ | 1% |
| í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) | 0.5% | ìë™ ê³„ì‚° | 0.5% |

#### 1.3.3 3ë‹¨ê³„ ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ

ë³´ìƒ ë¹„ìœ¨ì€ ë‹¤ìŒ ìš°ì„ ìˆœìœ„ë¡œ ê²°ì •ë©ë‹ˆë‹¤:

```
1ìˆœìœ„: ì œí’ˆë³„ ì„¤ì • (ProductSettings)
   â†“ (ì—†ìœ¼ë©´)
2ìˆœìœ„: ì‡¼í•‘ëª° ê¸°ë³¸ ì„¤ì • (MallSettings.defaultRewardSettings)
   â†“ (ì—†ìœ¼ë©´)
3ìˆœìœ„: ì‹œìŠ¤í…œ ê¸°ë³¸ê°’ (x=1%, y=1%, z=0.5%)
```

**ì˜ì‚¬ê²°ì • ë¡œì§:**

```
function getRewardRates(mallId: string, productId: string) {
  // 1ìˆœìœ„: ì œí’ˆë³„ ì„¤ì • í™•ì¸
  const productSettings = await prisma.productSettings.findUnique({
    where: { mallId_productId: { mallId, productId } }
  });
  
  if (productSettings) {
    return {
      reviewerPercent: productSettings.reviewerPercent,
      buyerPercent: productSettings.buyerPercent,
      platformPercent: (productSettings.reviewerPercent + productSettings.buyerPercent) * 0.25
    };
  }
  
  // 2ìˆœìœ„: ì‡¼í•‘ëª° ê¸°ë³¸ ì„¤ì •
  const mallSettings = await prisma.mallSettings.findUnique({
    where: { mallId }
  });
  
  if (mallSettings?.defaultRewardSettings) {
    return mallSettings.defaultRewardSettings;
  }
  
  // 3ìˆœìœ„: ì‹œìŠ¤í…œ ê¸°ë³¸ê°’
  return {
    reviewerPercent: 1.0,
    buyerPercent: 1.0,
    platformPercent: 0.5
  };
}
```

---

### 1.4 ë³´ìƒ ê³„ì‚° ì˜ˆì‹œ

#### ì˜ˆì‹œ 1: ê¸°ë³¸ ìš”ìœ¨ (1%, 1%)

| í•­ëª© | ê³„ì‚°ì‹ | ê¸ˆì•¡ |
|------|--------|------|
| êµ¬ë§¤ì•¡ | - | 100,000ì› |
| ë¦¬ë·° ì‘ì„±ì ì ë¦½ê¸ˆ (x=1%) | 100,000 Ã— 0.01 | **1,000ì›** |
| êµ¬ë§¤ì í• ì¸ (y=1%) | 100,000 Ã— 0.01 | **1,000ì›** |
| í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) | 100,000 Ã— (1+1)Ã—0.25% | **500ì›** |
| **ì‡¼í•‘ëª° ë¶€ë‹´ í•©ê³„** | 1,000 + 1,000 + 500 | **2,500ì› (2.5%)** |

#### ì˜ˆì‹œ 2: í”„ë¦¬ë¯¸ì—„ ì œí’ˆ (2%, 2%)

| í•­ëª© | ê³„ì‚°ì‹ | ê¸ˆì•¡ |
|------|--------|------|
| êµ¬ë§¤ì•¡ | - | 100,000ì› |
| ë¦¬ë·° ì‘ì„±ì ì ë¦½ê¸ˆ (x=2%) | 100,000 Ã— 0.02 | **2,000ì›** |
| êµ¬ë§¤ì í• ì¸ (y=2%) | 100,000 Ã— 0.02 | **2,000ì›** |
| í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) | 100,000 Ã— (2+2)Ã—0.25% | **1,000ì›** |
| **ì‡¼í•‘ëª° ë¶€ë‹´ í•©ê³„** | 2,000 + 2,000 + 1,000 | **5,000ì› (5%)** |

#### ì˜ˆì‹œ 3: ëŸ­ì…”ë¦¬ ì œí’ˆ (5%, 5%)

| í•­ëª© | ê³„ì‚°ì‹ | ê¸ˆì•¡ |
|------|--------|------|
| êµ¬ë§¤ì•¡ | - | 1,000,000ì› |
| ë¦¬ë·° ì‘ì„±ì ì ë¦½ê¸ˆ (x=5%) | 1,000,000 Ã— 0.05 | **50,000ì›** |
| êµ¬ë§¤ì í• ì¸ (y=5%) | 1,000,000 Ã— 0.05 | **50,000ì›** |
| í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) | 1,000,000 Ã— (5+5)Ã—0.25% | **25,000ì›** |
| **ì‡¼í•‘ëª° ë¶€ë‹´ í•©ê³„** | 50,000 + 50,000 + 25,000 | **125,000ì› (12.5%)** |

#### ì˜ˆì‹œ 4: í˜¼í•© ìš”ìœ¨ (ë¦¬ë·° ì‘ì„±ì 3%, êµ¬ë§¤ì 1%)

| í•­ëª© | ê³„ì‚°ì‹ | ê¸ˆì•¡ |
|------|--------|------|
| êµ¬ë§¤ì•¡ | - | 500,000ì› |
| ë¦¬ë·° ì‘ì„±ì ì ë¦½ê¸ˆ (x=3%) | 500,000 Ã— 0.03 | **15,000ì›** |
| êµ¬ë§¤ì í• ì¸ (y=1%) | 500,000 Ã— 0.01 | **5,000ì›** |
| í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ (z) | 500,000 Ã— (3+1)Ã—0.25% | **5,000ì›** |
| **ì‡¼í•‘ëª° ë¶€ë‹´ í•©ê³„** | 15,000 + 5,000 + 5,000 | **25,000ì› (5%)** |

---

## ğŸ¯ 2. í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš°

### 2.1 ì „ì²´ í”„ë¡œì„¸ìŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: ë¦¬ë·° ì‘ì„± (íšŒì› A)                                        â”‚
â”‚   â†“ ì¹´í˜24 ì‡¼í•‘ëª°ì—ì„œ êµ¬ë§¤ í›„ ë¦¬ë·° ì‘ì„±                             â”‚
â”‚   â†“ ScriptTagsë¡œ ì‚½ì…ëœ "Review2Earn ì°¸ì—¬í•˜ê¸°" ì²´í¬ë°•ìŠ¤ í‘œì‹œ       â”‚
â”‚   â†“ ë™ì˜ ì²´í¬ â†’ POST /api/consent â†’ DB ì €ì¥                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: ë¦¬ë·° ìë™ ê°ì§€                                            â”‚
â”‚   â†“ ì¹´í˜24 Webhook: board/product/created                        â”‚
â”‚   â†“ POST /api/webhooks/review ìˆ˜ì‹                                â”‚
â”‚   â†“ Review2Earn: ì¶”ì²œ ì½”ë“œ ìƒì„± (10ìë¦¬ nanoid)                  â”‚
â”‚   â†“ DB ì €ì¥: reviews í…Œì´ë¸”                                       â”‚
â”‚   â†“ ì œí’ˆë³„/ì‡¼í•‘ëª°ë³„ ìš”ìœ¨ ì¡°íšŒ í›„ referrals í…Œì´ë¸” ì €ì¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ì¶”ì²œ ë²„íŠ¼ í‘œì‹œ (íšŒì› B)                                   â”‚
â”‚   â†“ ë¦¬ë·° í˜ì´ì§€ì— ScriptTagsë¡œ ë²„íŠ¼ ìë™ ì‚½ì…                       â”‚
â”‚   â†“ GET /api/reviews/{review_id}/button                          â”‚
â”‚   â†“ ì œí’ˆë³„/ì‡¼í•‘ëª°ë³„ í• ì¸ìœ¨ ì¡°íšŒ â†’ "ë¦¬ë·°ë¡œ y% í• ì¸ë°›ê¸°!" ë²„íŠ¼ ìƒì„±   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: êµ¬ë§¤ ì „í™˜ ì¶”ì  (íšŒì› B)                                   â”‚
â”‚   â†“ ì¶”ì²œ ë²„íŠ¼ í´ë¦­ â†’ ì œí’ˆ í˜ì´ì§€ ì´ë™ (ì¿ í‚¤: r2e_ref=CODE)         â”‚
â”‚   â†“ êµ¬ë§¤ ì™„ë£Œ â†’ ì¹´í˜24 Webhook: order/confirm                     â”‚
â”‚   â†“ POST /api/webhooks/order ìˆ˜ì‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: ë³´ìƒ ìë™ ì§€ê¸‰                                            â”‚
â”‚   â†“ ì¿ í‚¤ì—ì„œ ì¶”ì²œ ì½”ë“œ í™•ì¸                                        â”‚
â”‚   â†“ ì œí’ˆë³„/ì‡¼í•‘ëª°ë³„ ë³´ìƒ ìš”ìœ¨ ì¡°íšŒ (ìš°ì„ ìˆœìœ„ ì ìš©)                   â”‚
â”‚   â†“ ë³´ìƒ ê³„ì‚°:                                                    â”‚
â”‚      - reviewer_reward = order_amount Ã— x%                       â”‚
â”‚      - buyer_discount = order_amount Ã— y%                        â”‚
â”‚      - platform_fee = order_amount Ã— (x+y)Ã—0.25%                 â”‚
â”‚   â†“ DB ì €ì¥: transactions í…Œì´ë¸”                                  â”‚
â”‚   â†“ ì¹´í˜24 API: ì ë¦½ê¸ˆ ì§€ê¸‰ (A)                                   â”‚
â”‚      POST /admin/customers/{customer_id}/mileage                â”‚
â”‚   â†“ ì¹´í˜24 API: ì¿ í° ë°œê¸‰ (B)                                     â”‚
â”‚      POST /admin/coupons                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ì°¸ì—¬ìë³„ ìƒì„¸ í”Œë¡œìš°

#### 2.2.1 ë¦¬ë·° ì‘ì„±ì (A) ê´€ì 

```
1. ì œí’ˆ êµ¬ë§¤ ì™„ë£Œ
   â†“
2. ë¦¬ë·° ì‘ì„± í˜ì´ì§€ ì ‘ì†
   â†“
3. "Review2Earnì— ì°¸ì—¬í•˜ê¸°" ì²´í¬ë°•ìŠ¤ í™•ì¸
   - ì²´í¬ ì‹œ: "ì´ ë¦¬ë·°ë¡œ êµ¬ë§¤ê°€ ë°œìƒí•˜ë©´ 1% ì ë¦½ê¸ˆì„ ë°›ìŠµë‹ˆë‹¤"
   â†“
4. ë¦¬ë·° ì œì¶œ
   â†“
5. ì¶”ì²œ ë§í¬ ìë™ ìƒì„± (ë°±ê·¸ë¼ìš´ë“œ)
   â†“
6. ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì´ ë¦¬ë·°ë¥¼ í†µí•´ êµ¬ë§¤
   â†“
7. ì ë¦½ê¸ˆ ìë™ ì§€ê¸‰ (ì•Œë¦¼ ë°œì†¡)
   â†“
8. ë¬´ì œí•œ ë°˜ë³µ ìˆ˜ìµ ê°€ëŠ¥
```

#### 2.2.2 êµ¬ë§¤ì (B) ê´€ì 

```
1. ì œí’ˆ í˜ì´ì§€ ì ‘ì†
   â†“
2. ë¦¬ë·° í™•ì¸
   â†“
3. "ë¦¬ë·°ë¡œ 1% í• ì¸ë°›ê¸°!" ë²„íŠ¼ í´ë¦­
   â†“
4. ì¿ í‚¤ì— ì¶”ì²œ ì½”ë“œ ì €ì¥ (30ì¼ ìœ íš¨)
   â†“
5. ì œí’ˆ êµ¬ë§¤
   â†“
6. 1% í• ì¸ ì¿ í° ìë™ ë°œê¸‰
   â†“
7. ë‹¤ìŒ êµ¬ë§¤ ì‹œ ìë™ ì ìš©
```

#### 2.2.3 ì‡¼í•‘ëª° ìš´ì˜ì ê´€ì 

```
1. Review2Earn ì•± ì„¤ì¹˜
   â†“
2. OAuth ì¸ì¦ ì™„ë£Œ
   â†“
3. ê¸°ë³¸ ìš”ìœ¨ ì„¤ì • (ì„ íƒ)
   - ì „ì²´ ì‡¼í•‘ëª°: 1%, 1%
   - íŠ¹ì • ì œí’ˆ: 2%, 2% (í”„ë¦¬ë¯¸ì—„)
   â†“
4. ScriptTags ìë™ ì„¤ì¹˜ (ì›í´ë¦­)
   â†“
5. ë¦¬ë·° ì‘ì„± ì‹œ ìë™ ë™ì‘
   â†“
6. êµ¬ë§¤ ë°œìƒ ì‹œ ë³´ìƒ ìë™ ì§€ê¸‰
   â†“
7. ëŒ€ì‹œë³´ë“œì—ì„œ ì‹¤ì‹œê°„ í†µê³„ í™•ì¸
   - ì´ ë¦¬ë·° ìˆ˜
   - ì¶”ì²œì„ í†µí•œ êµ¬ë§¤ ìˆ˜
   - ì§€ê¸‰í•œ ë³´ìƒ ê¸ˆì•¡
```

---

## ğŸ—ï¸ 3. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 3.1 ì „ì²´ êµ¬ì¡°ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ì¹´í˜24 ì‡¼í•‘ëª° (mallId.cafe24.com)                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  OAuth     â”‚  â”‚ ScriptTags â”‚  â”‚ Webhooks   â”‚            â”‚
â”‚  â”‚  ì¸ì¦      â”‚  â”‚ API        â”‚  â”‚ (ë¦¬ë·°/ì£¼ë¬¸) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Products   â”‚  â”‚ Orders     â”‚  â”‚ Customers  â”‚            â”‚
â”‚  â”‚ API        â”‚  â”‚ API        â”‚  â”‚ API        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†• HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Review2Earn (review2earn.vercel.app)                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Next.js 15 App Router (Frontend + API)               â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ Dashboardâ”‚  â”‚  OAuth   â”‚  â”‚ Webhooks â”‚           â”‚  â”‚
â”‚  â”‚  â”‚ (Admin)  â”‚  â”‚  Handler â”‚  â”‚ Handler  â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes (Serverless Functions)                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚ /api/oauth/*     â”‚  â”‚ /api/scripttags  â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ /api/consent     â”‚  â”‚ /api/reviews     â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ /api/webhooks/*  â”‚  â”‚ /api/rewards     â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Prisma ORM + PostgreSQL (Vercel Postgres)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ MallSettings â”‚  â”‚ Referrals    â”‚  â”‚ Rewards   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Reviews      â”‚  â”‚ Transactions â”‚  â”‚ Webhooks  â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ê¸°ìˆ  ìŠ¤íƒ

#### 3.2.1 Frontend
- **Next.js 15.0** (App Router)
- **React 19**
- **TypeScript 5.6**
- **Tailwind CSS 3.4**

#### 3.2.2 Backend
- **Next.js API Routes** (Serverless Functions)
- **Prisma ORM 5.20**
- **PostgreSQL 16** (Vercel Postgres)

#### 3.2.3 ë°°í¬ ë° ì¸í”„ë¼
- **Vercel** (Frontend + Serverless Backend)
- **Vercel Postgres** (Database)
- **GitHub** (Version Control)

#### 3.2.4 ì™¸ë¶€ API
- **Cafe24 Admin API v2**
  - OAuth 2.0 ì¸ì¦
  - ScriptTags API
  - Products API
  - Orders API
  - Customers API (ì ë¦½ê¸ˆ ì§€ê¸‰)
  - Coupons API

## 4. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 4.1 ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MallSettings   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)         â”‚
â”‚ mallId (UK)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ accessToken     â”‚           â”‚
â”‚ refreshToken    â”‚           â”‚
â”‚ expiresAt       â”‚           â”‚
â”‚ scopes          â”‚           â”‚
â”‚ isActive        â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ ProductSettings â”‚           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚ id (PK)         â”‚           â”‚
â”‚ mallId (FK)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ productId       â”‚           â”‚
â”‚ reviewerPercent â”‚           â”‚
â”‚ buyerPercent    â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    Reviews      â”‚           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚ id (PK)         â”‚           â”‚
â”‚ mallId (FK)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ reviewId        â”‚           â”‚
â”‚ productId       â”‚           â”‚
â”‚ customerId      â”‚           â”‚
â”‚ isR2EEnabled    â”‚           â”‚
â”‚ consentedAt     â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
        â”‚                     â”‚
        â”‚                     â”‚
        â–¼                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   Referrals     â”‚           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚ id (PK)         â”‚           â”‚
â”‚ mallId (FK)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ reviewId (FK)   â”‚           â”‚
â”‚ referralCode(UK)â”‚           â”‚
â”‚ clicks          â”‚           â”‚
â”‚ conversions     â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
        â”‚                     â”‚
        â”‚                     â”‚
        â–¼                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  Transactions   â”‚           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚ id (PK)         â”‚           â”‚
â”‚ mallId (FK)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ orderId (UK)    â”‚
â”‚ referralId (FK) â”‚
â”‚ orderAmount     â”‚
â”‚ reviewerReward  â”‚
â”‚ buyerDiscount   â”‚
â”‚ platformFee     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Prisma Schema (ì™„ì „íŒ)

```
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// ============================================
// Phase 1: OAuth & Settings (âœ… êµ¬í˜„ ì™„ë£Œ)
// ============================================

model MallSettings {
  id                      String    @id @default(cuid())
  mallId                  String    @unique
  
  // OAuth í† í°
  accessToken             String
  refreshToken            String?
  expiresAt               DateTime
  scopes                  String
  
  // ê¸°ë³¸ ë³´ìƒ ì„¤ì • (JSON)
  defaultRewardSettings   Json?     // { reviewerPercent: 1.0, buyerPercent: 1.0 }
  
  // ì•± ìƒíƒœ
  isActive                Boolean   @default(true)
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  // Relations
  productSettings         ProductSettings[]
  reviews                 Review[]
  referrals               Referral[]
  transactions            Transaction[]
  webhookLogs             WebhookLog[]
  
  @@map("mall_settings")
  @@index([mallId])
}

// ============================================
// Phase 2: ì œí’ˆë³„ ë³´ìƒ ì„¤ì • (ê³„íš)
// ============================================

model ProductSettings {
  id                String    @id @default(cuid())
  mallId            String
  productId         String
  
  // ë³´ìƒ ë¹„ìœ¨
  reviewerPercent   Decimal   @db.Decimal(5, 2) // 0.00 ~ 100.00
  buyerPercent      Decimal   @db.Decimal(5, 2)
  
  // í™œì„±í™” ì—¬ë¶€
  isActive          Boolean   @default(true)
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  mall              MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  
  @@unique([mallId, productId])
  @@map("product_settings")
  @@index([mallId, productId])
}

// ============================================
// Phase 2: ë¦¬ë·° ê´€ë¦¬ (ê³„íš)
// ============================================

model Review {
  id                String    @id @default(cuid())
  mallId            String
  reviewId          String    // ì¹´í˜24 ë¦¬ë·° ID
  productId         String
  customerId        String
  customerEmail     String?
  
  // ë¦¬ë·° ë‚´ìš©
  content           String?
  rating            Int?
  
  // Review2Earn ë™ì˜ ì—¬ë¶€
  isR2EEnabled      Boolean   @default(false)
  consentedAt       DateTime?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  mall              MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  referrals         Referral[]
  
  @@unique([mallId, reviewId])
  @@map("reviews")
  @@index([mallId, reviewId])
  @@index([mallId, productId])
  @@index([customerId])
}

// ============================================
// Phase 2: ì¶”ì²œ ë§í¬ (ê³„íš)
// ============================================

model Referral {
  id                String    @id @default(cuid())
  mallId            String
  reviewId          String
  referralCode      String    @unique // 10ìë¦¬ nanoid
  
  // í†µê³„
  clicks            Int       @default(0)
  conversions       Int       @default(0)
  totalRevenue      Decimal   @default(0) @db.Decimal(10, 2)
  totalReward       Decimal   @default(0) @db.Decimal(10, 2)
  
  // í™œì„±í™” ìƒíƒœ
  isActive          Boolean   @default(true)
  expiresAt         DateTime? // ë§Œë£Œ ì‹œê°„ (ì„ íƒ)
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  mall              MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  review            Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  
  @@map("referrals")
  @@index([referralCode])
  @@index([mallId, reviewId])
  @@index([createdAt])
}

// ============================================
// Phase 3: ê±°ë˜ ë‚´ì—­ (ê³„íš)
// ============================================

model Transaction {
  id                String    @id @default(cuid())
  mallId            String
  orderId           String    // ì¹´í˜24 ì£¼ë¬¸ ID
  referralId        String
  
  // êµ¬ë§¤ì ì •ë³´
  customerId        String
  customerEmail     String?
  
  // ì œí’ˆ ì •ë³´
  productId         String
  productName       String
  quantity          Int
  
  // ê¸ˆì•¡ ì •ë³´
  orderAmount       Decimal   @db.Decimal(10, 2)
  reviewerReward    Decimal   @db.Decimal(10, 2) // x%
  buyerDiscount     Decimal   @db.Decimal(10, 2) // y%
  platformFee       Decimal   @db.Decimal(10, 2) // z%
  
  // ë³´ìƒ ì§€ê¸‰ ìƒíƒœ
  rewardStatus      String    @default("pending") // pending, processing, completed, failed
  rewardPaidAt      DateTime?
  
  // í• ì¸ ì¿ í° ë°œê¸‰ ìƒíƒœ
  couponStatus      String    @default("pending")
  couponCode        String?
  couponIssuedAt    DateTime?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  orderedAt         DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  mall              MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  referral          Referral  @relation(fields: [referralId], references: [id])
  
  @@unique([mallId, orderId])
  @@map("transactions")
  @@index([mallId, orderId])
  @@index([referralId])
  @@index([customerId])
  @@index([rewardStatus])
  @@index([orderedAt])
}

// ============================================
// Phase 3: Webhook ë¡œê·¸ (ê³„íš)
// ============================================

model WebhookLog {
  id                String    @id @default(cuid())
  mallId            String
  event             String    // order.created, review.created, etc.
  payload           Json
  
  // ì²˜ë¦¬ ìƒíƒœ
  processed         Boolean   @default(false)
  processedAt       DateTime?
  error             String?
  
  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt         DateTime  @default(now())
  
  // Relations
  mall              MallSettings @relation(fields: [mallId], references: [mallId], onDelete: Cascade)
  
  @@map("webhook_logs")
  @@index([mallId, event])
  @@index([processed])
  @@index([createdAt])
}
```

### 4.3 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```
# ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ (Phase 1)
npx prisma migrate dev --name init

# ìƒˆ í•„ë“œ ì¶”ê°€ ì˜ˆì‹œ
npx prisma migrate dev --name add_product_settings

# í”„ë¡œë•ì…˜ ë°°í¬
npx prisma migrate deploy
```

### 4.4 ì¸ë±ìŠ¤ ìµœì í™” ì „ëµ

| í…Œì´ë¸” | ì¸ë±ìŠ¤ | ëª©ì  |
|--------|--------|------|
| `MallSettings` | `mallId` (UNIQUE) | OAuth í† í° ì¡°íšŒ ìµœì í™” |
| `ProductSettings` | `(mallId, productId)` (UNIQUE) | ì œí’ˆë³„ ìš”ìœ¨ ì¡°íšŒ |
| `Reviews` | `(mallId, reviewId)` (UNIQUE) | ë¦¬ë·° ì¤‘ë³µ ë°©ì§€ |
| `Referrals` | `referralCode` (UNIQUE) | ì¶”ì²œ ë§í¬ ì¶”ì  |
| `Transactions` | `(mallId, orderId)` (UNIQUE) | ì£¼ë¬¸ ì¤‘ë³µ ë°©ì§€ |
| `Transactions` | `rewardStatus` | ë¯¸ì§€ê¸‰ ë³´ìƒ ì¡°íšŒ |
| `WebhookLog` | `(mallId, event)` | Webhook ì´ë²¤íŠ¸ ì¡°íšŒ |

---

## 5. Phase 1 êµ¬í˜„ ì™„ë£Œ (2025.10.08)

### 5.1 OAuth 2.0 ì¸ì¦ ì‹œìŠ¤í…œ

#### 5.1.1 êµ¬í˜„ íŒŒì¼

```
src/app/api/oauth/
â”œâ”€â”€ auth-url/route.ts         # OAuth URL ìƒì„±
â”œâ”€â”€ callback/route.ts          # í† í° êµí™˜ + DB ì €ì¥
â””â”€â”€ verify/route.ts            # í† í° ê¶Œí•œ ê²€ì¦
```

#### 5.1.2 OAuth URL ìƒì„± API

**Endpoint:** `POST /api/oauth/auth-url`

**Request Body:**
```
{
  "mallId": "review2earn"
}
```

**Response:**
```
{
  "success": true,
  "authUrl": "https://review2earn.cafe24.com/api/v2/oauth/authorize?response_type=code&client_id=WYht5QinOtql2mDJe0hVvA&state=eyJtYWxsSWQiOiJyZXZpZXcyZWFybiIsInRpbWVzdGFtcCI6MTc1OTkyODAxMTU4NH0&redirect_uri=https://review2earn.vercel.app/api/oauth/callback&scope=mall.read_product,mall.write_design"
}
```

**êµ¬í˜„ ì½”ë“œ:**

```
// src/app/api/oauth/auth-url/route.ts
import { NextRequest, NextResponse } from 'next/server';

const CAFE24_CLIENT_ID = process.env.CAFE24_CLIENT_ID!;
const CAFE24_REDIRECT_URI = process.env.CAFE24_REDIRECT_URI!;

export async function POST(request: NextRequest) {
  try {
    const { mallId } = await request.json();

    if (!mallId) {
      return NextResponse.json(
        { success: false, message: 'Mall IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    // State ìƒì„± (CSRF ë°©ì–´)
    const state = Buffer.from(
      JSON.stringify({
        mallId,
        timestamp: Date.now(),
        random: Math.random().toString(36).substring(7)
      })
    ).toString('base64');

    // OAuth URL ìƒì„±
    const authUrl = new URL(`https://${mallId}.cafe24.com/api/v2/oauth/authorize`);
    authUrl.searchParams.append('response_type', 'code');
    authUrl.searchParams.append('client_id', CAFE24_CLIENT_ID);
    authUrl.searchParams.append('state', state);
    authUrl.searchParams.append('redirect_uri', CAFE24_REDIRECT_URI);
    authUrl.searchParams.append('scope', [
      'mall.read_product',
      'mall.read_order',
      'mall.read_community',
      'mall.write_community',
      'mall.read_customer',
      'mall.write_customer',
      'mall.read_promotion',
      'mall.write_promotion',
      'mall.read_design',
      'mall.write_design',
      'mall.read_application',
      'mall.write_application'
    ].join(','));

    return NextResponse.json({
      success: true,
      authUrl: authUrl.toString()
    });

  } catch (error) {
    console.error('OAuth URL ìƒì„± ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
}
```

#### 5.1.3 OAuth Callback API

**Endpoint:** `GET /api/oauth/callback?code=xxx&state=yyy`

**ì²˜ë¦¬ ê³¼ì •:**
1. State ê²€ì¦ (CSRF ë°©ì–´)
2. Authorization Code â†’ Access Token êµí™˜
3. DBì— í† í° ì €ì¥ (MallSettings)
4. í”„ë¡ íŠ¸ì—”ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**êµ¬í˜„ ì½”ë“œ:**

```
// src/app/api/oauth/callback/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

const CAFE24_CLIENT_ID = process.env.CAFE24_CLIENT_ID!;
const CAFE24_CLIENT_SECRET = process.env.CAFE24_CLIENT_SECRET!;
const CAFE24_REDIRECT_URI = process.env.CAFE24_REDIRECT_URI!;

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const code = searchParams.get('code');
    const state = searchParams.get('state');

    if (!code || !state) {
      return NextResponse.redirect(
        `${process.env.NEXT_PUBLIC_BASE_URL}/?error=missing_params`
      );
    }

    // State íŒŒì‹± ë° ê²€ì¦
    const stateData = JSON.parse(
      Buffer.from(state, 'base64').toString('utf-8')
    );

    const { mallId, timestamp } = stateData;

    // íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (10ë¶„ ìœ íš¨)
    if (Date.now() - timestamp > 10 * 60 * 1000) {
      return NextResponse.redirect(
        `${process.env.NEXT_PUBLIC_BASE_URL}/?error=expired_state`
      );
    }

    // Access Token ìš”ì²­
    const tokenUrl = `https://${mallId}.cafe24api.com/api/v2/oauth/token`;
    const tokenResponse = await fetch(tokenUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code,
        redirect_uri: CAFE24_REDIRECT_URI,
        client_id: CAFE24_CLIENT_ID,
        client_secret: CAFE24_CLIENT_SECRET
      })
    });

    if (!tokenResponse.ok) {
      console.error('í† í° êµí™˜ ì‹¤íŒ¨:', await tokenResponse.text());
      return NextResponse.redirect(
        `${process.env.NEXT_PUBLIC_BASE_URL}/?error=token_exchange_failed`
      );
    }

    const tokenData = await tokenResponse.json();

    // DBì— ì €ì¥
    await prisma.mallSettings.upsert({
      where: { mallId },
      create: {
        mallId,
        accessToken: tokenData.access_token,
        refreshToken: tokenData.refresh_token,
        expiresAt: new Date(Date.now() + tokenData.expires_in * 1000),
        scopes: tokenData.scope,
        isActive: true
      },
      update: {
        accessToken: tokenData.access_token,
        refreshToken: tokenData.refresh_token,
        expiresAt: new Date(Date.now() + tokenData.expires_in * 1000),
        scopes: tokenData.scope,
        updatedAt: new Date()
      }
    });

    // ì„±ê³µ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return NextResponse.redirect(
      `${process.env.NEXT_PUBLIC_BASE_URL}/?oauth_success=true&mall_id=${mallId}`
    );

  } catch (error) {
    console.error('OAuth Callback ì˜¤ë¥˜:', error);
    return NextResponse.redirect(
      `${process.env.NEXT_PUBLIC_BASE_URL}/?error=server_error`
    );
  }
}
```

---

### 5.2 ScriptTags API í†µí•©

#### 5.2.1 êµ¬í˜„ íŒŒì¼

```
src/app/api/scripttags/
â”œâ”€â”€ install/route.ts           # ScriptTag ì„¤ì¹˜
â””â”€â”€ uninstall/route.ts         # ScriptTag ì œê±°
```

#### 5.2.2 ScriptTag ì„¤ì¹˜ API

**Endpoint:** `POST /api/scripttags/install`

**Request Body:**
```
{
  "mallId": "review2earn"
}
```

**Response:**
```
{
  "success": true,
  "message": "âœ… ScriptTag ì„¤ì¹˜ ì™„ë£Œ!",
  "scriptTagId": 12345
}
```

**êµ¬í˜„ ì½”ë“œ:**

```
// src/app/api/scripttags/install/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function POST(request: NextRequest) {
  try {
    const { mallId } = await request.json();

    // DBì—ì„œ Access Token ì¡°íšŒ
    const mallSettings = await prisma.mallSettings.findUnique({
      where: { mallId }
    });

    if (!mallSettings || !mallSettings.accessToken) {
      return NextResponse.json(
        { success: false, message: 'OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 401 }
      );
    }

    const accessToken = mallSettings.accessToken;

    // 1. ê¸°ì¡´ ScriptTag í™•ì¸
    const listUrl = `https://${mallId}.cafe24api.com/api/v2/admin/scripttags`;
    const listResponse = await fetch(listUrl, {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });

    if (listResponse.ok) {
      const { scripttags } = await listResponse.json();
      const existing = scripttags.find(
        (tag: any) => tag.src === 'https://review2earn.vercel.app/scripts/review-consent.js'
      );

      if (existing) {
        return NextResponse.json({
          success: false,
          message: 'âš ï¸ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
          scriptTagId: existing.script_no
        });
      }
    }

    // 2. ìƒˆ ScriptTag ì„¤ì¹˜
    const createUrl = `https://${mallId}.cafe24api.com/api/v2/admin/scripttags`;
    const createResponse = await fetch(createUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        request: {
          src: 'https://review2earn.vercel.app/scripts/review-consent.js',
          display_location: ['BOARD_WRITE'],
          exclude_path: []
        }
      })
    });

    if (!createResponse.ok) {
      const errorText = await createResponse.text();
      console.error('ScriptTag ì„¤ì¹˜ ì‹¤íŒ¨:', errorText);
      return NextResponse.json(
        { success: false, message: 'ì„¤ì¹˜ ì‹¤íŒ¨', error: errorText },
        { status: 500 }
      );
    }

    const { scripttag } = await createResponse.json();

    return NextResponse.json({
      success: true,
      message: 'âœ… ScriptTag ì„¤ì¹˜ ì™„ë£Œ!',
      scriptTagId: scripttag.script_no
    });

  } catch (error) {
    console.error('ScriptTag ì„¤ì¹˜ ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜' },
      { status: 500 }
    );
  }
}
```
## 6. Phase 2 ê°œë°œ ê³„íš (ë¦¬ë·° ë™ì˜ + ì¶”ì²œ ë§í¬)

### 6.1 ëª©í‘œ

- âœ… ë¦¬ë·° ì‘ì„± ì‹œ Review2Earn ë™ì˜ ìˆ˜ì§‘
- âœ… ì¶”ì²œ ë§í¬ ìë™ ìƒì„±
- âœ… ì¶”ì²œ ë§í¬ í´ë¦­ ì¶”ì 
- âœ… ë¦¬ë·° í˜ì´ì§€ì— ì¶”ì²œ ë²„íŠ¼ ìë™ ì‚½ì…

### 6.2 êµ¬í˜„ ì˜ˆì • API

#### 6.2.1 ë¦¬ë·° ë™ì˜ ìˆ˜ì§‘ API

**Endpoint:** `POST /api/consent`

**Request Body:**
```
{
  "mallId": "review2earn",
  "reviewId": "12345",
  "productId": "67890",
  "customerId": "user123",
  "customerEmail": "user@example.com"
}
```

**Response:**
```
{
  "success": true,
  "message": "Review2Earn ì°¸ì—¬ ì™„ë£Œ!",
  "referralLink": "https://review2earn.cafe24.com/product/67890?ref=R2E1234567",
  "referralCode": "R2E1234567"
}
```

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// src/app/api/consent/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { nanoid } from 'nanoid';

export async function POST(request: NextRequest) {
  try {
    const { mallId, reviewId, productId, customerId, customerEmail } = await request.json();

    // 1. Review ë ˆì½”ë“œ ìƒì„±
    const review = await prisma.review.upsert({
      where: { mallId_reviewId: { mallId, reviewId } },
      create: {
        mallId,
        reviewId,
        productId,
        customerId,
        customerEmail,
        isR2EEnabled: true,
        consentedAt: new Date()
      },
      update: {
        isR2EEnabled: true,
        consentedAt: new Date()
      }
    });

    // 2. ì¶”ì²œ ì½”ë“œ ìƒì„± (10ìë¦¬)
    const referralCode = 'R2E' + nanoid(7);

    // 3. Referral ë ˆì½”ë“œ ìƒì„±
    const referral = await prisma.referral.create({
      data: {
        mallId,
        reviewId: review.id,
        referralCode,
        isActive: true
      }
    });

    // 4. ì¶”ì²œ ë§í¬ ìƒì„±
    const referralLink = `https://${mallId}.cafe24.com/product/${productId}?ref=${referralCode}`;

    return NextResponse.json({
      success: true,
      message: 'Review2Earn ì°¸ì—¬ ì™„ë£Œ!',
      referralLink,
      referralCode
    });

  } catch (error) {
    console.error('Consent API ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜' },
      { status: 500 }
    );
  }
}
```

#### 6.2.2 ì¶”ì²œ ë§í¬ ì¶”ì  API

**Endpoint:** `GET /api/track?ref=R2E1234567`

**ì²˜ë¦¬ ê³¼ì •:**
1. ì¶”ì²œ ì½”ë“œ ìœ íš¨ì„± í™•ì¸
2. í´ë¦­ ìˆ˜ ì¦ê°€ (Referrals.clicks + 1)
3. ì¿ í‚¤ì— ì¶”ì²œ ì½”ë“œ ì €ì¥ (30ì¼ ìœ íš¨)
4. ì œí’ˆ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// src/app/api/track/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const referralCode = searchParams.get('ref');
    const productId = searchParams.get('product_id');

    if (!referralCode) {
      return NextResponse.redirect('/');
    }

    // Referral ì¡°íšŒ
    const referral = await prisma.referral.findUnique({
      where: { referralCode },
      include: {
        review: true,
        mall: true
      }
    });

    if (!referral || !referral.isActive) {
      return NextResponse.redirect('/');
    }

    // í´ë¦­ ìˆ˜ ì¦ê°€
    await prisma.referral.update({
      where: { referralCode },
      data: {
        clicks: { increment: 1 },
        updatedAt: new Date()
      }
    });

    // ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ìƒì„±
    const redirectUrl = `https://${referral.mallId}.cafe24.com/product/${productId || referral.review.productId}`;
    
    const response = NextResponse.redirect(redirectUrl);

    // ì¿ í‚¤ ì„¤ì • (30ì¼ ìœ íš¨)
    response.cookies.set('r2e_ref', referralCode, {
      maxAge: 30 * 24 * 60 * 60, // 30ì¼
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax'
    });

    return response;

  } catch (error) {
    console.error('Track API ì˜¤ë¥˜:', error);
    return NextResponse.redirect('/');
  }
}
```

#### 6.2.3 ë¦¬ë·° ë²„íŠ¼ ë°ì´í„° API

**Endpoint:** `GET /api/reviews/{reviewId}/button`

**Response:**
```
{
  "success": true,
  "hasReferral": true,
  "referralCode": "R2E1234567",
  "discountPercent": 1.0,
  "buttonText": "ì´ ë¦¬ë·°ë¡œ 1% í• ì¸ë°›ê¸°!"
}
```

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// src/app/api/reviews/[reviewId]/button/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(
  request: NextRequest,
  { params }: { params: { reviewId: string } }
) {
  try {
    const { reviewId } = params;
    const { searchParams } = new URL(request.url);
    const mallId = searchParams.get('mall_id');

    if (!mallId) {
      return NextResponse.json(
        { success: false, message: 'Mall ID í•„ìš”' },
        { status: 400 }
      );
    }

    // Review ì¡°íšŒ
    const review = await prisma.review.findUnique({
      where: { mallId_reviewId: { mallId, reviewId } },
      include: {
        referrals: {
          where: { isActive: true },
          take: 1
        }
      }
    });

    if (!review || !review.isR2EEnabled) {
      return NextResponse.json({
        success: true,
        hasReferral: false
      });
    }

    const referral = review.referrals;

    if (!referral) {
      return NextResponse.json({
        success: true,
        hasReferral: false
      });
    }

    // ë³´ìƒ ë¹„ìœ¨ ì¡°íšŒ (ìš°ì„ ìˆœìœ„: ì œí’ˆë³„ > ì‡¼í•‘ëª° > ê¸°ë³¸ê°’)
    const productSettings = await prisma.productSettings.findUnique({
      where: { mallId_productId: { mallId, productId: review.productId } }
    });

    let buyerPercent = 1.0;

    if (productSettings) {
      buyerPercent = Number(productSettings.buyerPercent);
    } else {
      const mallSettings = await prisma.mallSettings.findUnique({
        where: { mallId }
      });

      if (mallSettings?.defaultRewardSettings) {
        buyerPercent = (mallSettings.defaultRewardSettings as any).buyerPercent || 1.0;
      }
    }

    return NextResponse.json({
      success: true,
      hasReferral: true,
      referralCode: referral.referralCode,
      discountPercent: buyerPercent,
      buttonText: `ì´ ë¦¬ë·°ë¡œ ${buyerPercent}% í• ì¸ë°›ê¸°!`
    });

  } catch (error) {
    console.error('Button API ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜' },
      { status: 500 }
    );
  }
}
```

### 6.3 ScriptTag ìŠ¤í¬ë¦½íŠ¸ (review-consent.js)

**íŒŒì¼ ìœ„ì¹˜:** `public/scripts/review-consent.js`

**ê¸°ëŠ¥:**
1. ë¦¬ë·° ì‘ì„± í˜ì´ì§€ ê°ì§€
2. "Review2Earn ì°¸ì—¬í•˜ê¸°" ì²´í¬ë°•ìŠ¤ ì¶”ê°€
3. ë¦¬ë·° ì œì¶œ ì‹œ ë™ì˜ ì •ë³´ ì „ì†¡

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// public/scripts/review-consent.js
(function() {
  'use strict';

  // ë¦¬ë·° ì‘ì„± í˜ì´ì§€ì¸ì§€ í™•ì¸
  if (!window.location.pathname.includes('/board/product/write')) {
    return;
  }

  console.log('Review2Earn: ë¦¬ë·° ì‘ì„± í˜ì´ì§€ ê°ì§€');

  // Mall ID ì¶”ì¶œ
  const mallId = window.location.hostname.split('.');

  // ì²´í¬ë°•ìŠ¤ HTML
  const checkboxHtml = `
    <div id="r2e-consent-wrapper" style="margin: 20px 0; padding: 15px; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="r2e-consent-checkbox" style="width: 20px; height: 20px; margin-right: 10px;">
        <div>
          <strong style="color: #1e40af;">Review2Earnì— ì°¸ì—¬í•˜ê¸°</strong>
          <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #64748b;">
            ì´ ë¦¬ë·°ë¥¼ í†µí•´ êµ¬ë§¤ê°€ ë°œìƒí•˜ë©´ êµ¬ë§¤ì•¡ì˜ 1%ë¥¼ ì ë¦½ê¸ˆìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤!
          </p>
        </div>
      </label>
    </div>
  `;

  // í¼ ì°¾ê¸°
  const form = document.querySelector('form[name="boardWriteForm"]');
  
  if (!form) {
    console.error('Review2Earn: ë¦¬ë·° ì‘ì„± í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ì²´í¬ë°•ìŠ¤ ì‚½ì…
  const submitButton = form.querySelector('button[type="submit"]');
  if (submitButton) {
    submitButton.insertAdjacentHTML('beforebegin', checkboxHtml);
  }

  // í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°ì§€
  form.addEventListener('submit', async function(event) {
    const checkbox = document.getElementById('r2e-consent-checkbox');

    if (!checkbox || !checkbox.checked) {
      return; // ë™ì˜í•˜ì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
    }

    // ë¦¬ë·° ë°ì´í„° ì¶”ì¶œ
    const productId = new URLSearchParams(window.location.search).get('product_no');
    const customerId = getCookie('member_id'); // ì¹´í˜24 íšŒì› ID ì¿ í‚¤

    if (!productId || !customerId) {
      console.error('Review2Earn: ì œí’ˆ ID ë˜ëŠ” íšŒì› IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // Review2Earn API í˜¸ì¶œ (ë¹„ë™ê¸°, ë¸”ë¡œí‚¹ ì—†ìŒ)
    setTimeout(async () => {
      try {
        const response = await fetch('https://review2earn.vercel.app/api/consent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            mallId,
            reviewId: 'pending', // Webhookìœ¼ë¡œ ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸
            productId,
            customerId
          })
        });

        const data = await response.json();
        console.log('Review2Earn ì°¸ì—¬ ì™„ë£Œ:', data);

      } catch (error) {
        console.error('Review2Earn API ì˜¤ë¥˜:', error);
      }
    }, 0);
  });

  // ì¿ í‚¤ ì½ê¸° í—¬í¼
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

})();
```

---

## 7. Phase 3 ê°œë°œ ê³„íš (ì£¼ë¬¸ ì¶”ì  + ìë™ ë³´ìƒ)

### 7.1 ëª©í‘œ

- âœ… ì¹´í˜24 ì£¼ë¬¸ Webhook ìˆ˜ì‹ 
- âœ… ì¶”ì²œ ë§í¬ í™•ì¸ (ì¿ í‚¤ ê¸°ë°˜)
- âœ… ë³´ìƒ ìë™ ê³„ì‚° (ì œí’ˆë³„/ì‡¼í•‘ëª°ë³„ ìš”ìœ¨ ì ìš©)
- âœ… ì ë¦½ê¸ˆ ìë™ ì§€ê¸‰ (ë¦¬ë·° ì‘ì„±ì)
- âœ… í• ì¸ ì¿ í° ìë™ ë°œê¸‰ (êµ¬ë§¤ì)

### 7.2 Webhook ì„¤ì •

#### 7.2.1 ì¹´í˜24 Webhook ë“±ë¡

**ì´ë²¤íŠ¸:** `order/confirm` (ì£¼ë¬¸ í™•ì •)

**Webhook URL:** `https://review2earn.vercel.app/api/webhooks/order`

**ì„¤ì • ë°©ë²•:**
1. ì¹´í˜24 ê´€ë¦¬ì â†’ ì•±ìŠ¤í† ì–´ â†’ Review2Earn
2. Webhook ì„¤ì •
3. `order/confirm` ì´ë²¤íŠ¸ ì„ íƒ
4. URL ì…ë ¥: `https://review2earn.vercel.app/api/webhooks/order`
5. ì €ì¥

#### 7.2.2 Webhook ìˆ˜ì‹  API

**Endpoint:** `POST /api/webhooks/order`

**Request Body (ì¹´í˜24ì—ì„œ ì „ì†¡):**
```
{
  "resource": {
    "mall_id": "review2earn",
    "order_id": "20251008-0001234",
    "currency": "KRW",
    "order_date": "2025-10-08T22:30:00+09:00",
    "items": [
      {
        "product_no": 12345,
        "product_name": "í…ŒìŠ¤íŠ¸ ìƒí’ˆ",
        "quantity": 1,
        "product_price": "100000.00"
      }
    ],
    "member_id": "user123",
    "member_email": "user@example.com"
  }
}
```

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// src/app/api/webhooks/order/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function POST(request: NextRequest) {
  try {
    const webhookData = await request.json();
    const { resource } = webhookData;

    const {
      mall_id: mallId,
      order_id: orderId,
      items,
      member_id: customerId,
      member_email: customerEmail
    } = resource;

    // 1. Webhook ë¡œê·¸ ì €ì¥
    await prisma.webhookLog.create({
      data: {
        mallId,
        event: 'order.confirm',
        payload: webhookData,
        processed: false
      }
    });

    // 2. ì¿ í‚¤ì—ì„œ ì¶”ì²œ ì½”ë“œ í™•ì¸
    const referralCode = request.cookies.get('r2e_ref')?.value;

    if (!referralCode) {
      console.log('ì¶”ì²œ ì½”ë“œ ì—†ìŒ - ì¼ë°˜ ì£¼ë¬¸');
      return NextResponse.json({ success: true, message: 'ì¼ë°˜ ì£¼ë¬¸' });
    }

    // 3. Referral ì¡°íšŒ
    const referral = await prisma.referral.findUnique({
      where: { referralCode },
      include: {
        review: true,
        mall: true
      }
    });

    if (!referral || !referral.isActive) {
      console.log('ìœ íš¨í•˜ì§€ ì•Šì€ ì¶”ì²œ ì½”ë“œ');
      return NextResponse.json({ success: true, message: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì¶”ì²œ ì½”ë“œ' });
    }

    // 4. ê° ìƒí’ˆë³„ ë³´ìƒ ê³„ì‚° ë° ì§€ê¸‰
    for (const item of items) {
      const orderAmount = parseFloat(item.product_price) * item.quantity;

      // ë³´ìƒ ë¹„ìœ¨ ì¡°íšŒ (ìš°ì„ ìˆœìœ„: ì œí’ˆë³„ > ì‡¼í•‘ëª° > ê¸°ë³¸ê°’)
      const rates = await getRewardRates(mallId, item.product_no.toString());

      const reviewerReward = orderAmount * (rates.reviewerPercent / 100);
      const buyerDiscount = orderAmount * (rates.buyerPercent / 100);
      const platformFee = orderAmount * (rates.platformPercent / 100);

      // 5. Transaction ë ˆì½”ë“œ ìƒì„±
      const transaction = await prisma.transaction.create({
        data: {
          mallId,
          orderId: `${orderId}-${item.product_no}`,
          referralId: referral.id,
          customerId,
          customerEmail,
          productId: item.product_no.toString(),
          productName: item.product_name,
          quantity: item.quantity,
          orderAmount,
          reviewerReward,
          buyerDiscount,
          platformFee,
          rewardStatus: 'pending',
          couponStatus: 'pending',
          orderedAt: new Date(resource.order_date)
        }
      });

      // 6. ë¹„ë™ê¸° ë³´ìƒ ì§€ê¸‰ (ë°±ê·¸ë¼ìš´ë“œ)
      processRewards(transaction.id);
    }

    // 7. Referral í†µê³„ ì—…ë°ì´íŠ¸
    await prisma.referral.update({
      where: { referralCode },
      data: {
        conversions: { increment: 1 },
        updatedAt: new Date()
      }
    });

    return NextResponse.json({
      success: true,
      message: 'ì£¼ë¬¸ ì²˜ë¦¬ ì™„ë£Œ'
    });

  } catch (error) {
    console.error('Webhook ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜' },
      { status: 500 }
    );
  }
}

// ë³´ìƒ ë¹„ìœ¨ ì¡°íšŒ í•¨ìˆ˜
async function getRewardRates(mallId: string, productId: string) {
  // 1ìˆœìœ„: ì œí’ˆë³„ ì„¤ì •
  const productSettings = await prisma.productSettings.findUnique({
    where: { mallId_productId: { mallId, productId } }
  });

  if (productSettings) {
    const reviewerPercent = Number(productSettings.reviewerPercent);
    const buyerPercent = Number(productSettings.buyerPercent);
    return {
      reviewerPercent,
      buyerPercent,
      platformPercent: (reviewerPercent + buyerPercent) * 0.25
    };
  }

  // 2ìˆœìœ„: ì‡¼í•‘ëª° ê¸°ë³¸ ì„¤ì •
  const mallSettings = await prisma.mallSettings.findUnique({
    where: { mallId }
  });

  if (mallSettings?.defaultRewardSettings) {
    const settings = mallSettings.defaultRewardSettings as any;
    return {
      reviewerPercent: settings.reviewerPercent || 1.0,
      buyerPercent: settings.buyerPercent || 1.0,
      platformPercent: ((settings.reviewerPercent || 1.0) + (settings.buyerPercent || 1.0)) * 0.25
    };
  }

  // 3ìˆœìœ„: ì‹œìŠ¤í…œ ê¸°ë³¸ê°’
  return {
    reviewerPercent: 1.0,
    buyerPercent: 1.0,
    platformPercent: 0.5
  };
}

// ë³´ìƒ ì§€ê¸‰ ì²˜ë¦¬ (ë¹„ë™ê¸°)
async function processRewards(transactionId: string) {
  // ì´ í•¨ìˆ˜ëŠ” ë³„ë„ì˜ í ì‹œìŠ¤í…œìœ¼ë¡œ ì²˜ë¦¬ (í–¥í›„ ê°œì„ )
  // í˜„ì¬ëŠ” setTimeoutìœ¼ë¡œ ë¹„ë™ê¸° ì²˜ë¦¬
  setTimeout(async () => {
    try {
      const transaction = await prisma.transaction.findUnique({
        where: { id: transactionId },
        include: {
          mall: true,
          referral: {
            include: { review: true }
          }
        }
      });

      if (!transaction) return;

      // 1. ë¦¬ë·° ì‘ì„±ìì—ê²Œ ì ë¦½ê¸ˆ ì§€ê¸‰
      await grantMileage(
        transaction.mallId,
        transaction.referral.review.customerId,
        transaction.reviewerReward,
        `Review2Earn: ${transaction.productName} ì¶”ì²œ ë³´ìƒ`
      );

      // 2. êµ¬ë§¤ìì—ê²Œ ì¿ í° ë°œê¸‰
      await issueCoupon(
        transaction.mallId,
        transaction.customerId,
        transaction.buyerDiscount
      );

      // 3. Transaction ìƒíƒœ ì—…ë°ì´íŠ¸
      await prisma.transaction.update({
        where: { id: transactionId },
        data: {
          rewardStatus: 'completed',
          rewardPaidAt: new Date(),
          couponStatus: 'completed',
          couponIssuedAt: new Date()
        }
      });

    } catch (error) {
      console.error('ë³´ìƒ ì§€ê¸‰ ì˜¤ë¥˜:', error);
      
      await prisma.transaction.update({
        where: { id: transactionId },
        data: {
          rewardStatus: 'failed'
        }
      });
    }
  }, 0);
}

// ì ë¦½ê¸ˆ ì§€ê¸‰ í•¨ìˆ˜
async function grantMileage(
  mallId: string,
  customerId: string,
  amount: number,
  reason: string
) {
  const mallSettings = await prisma.mallSettings.findUnique({
    where: { mallId }
  });

  if (!mallSettings) throw new Error('Mall settings not found');

  const url = `https://${mallId}.cafe24api.com/api/v2/admin/customers/${customerId}/mileage`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${mallSettings.accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      request: {
        mileage: Math.round(amount),
        reason
      }
    })
  });

  if (!response.ok) {
    throw new Error(`ì ë¦½ê¸ˆ ì§€ê¸‰ ì‹¤íŒ¨: ${await response.text()}`);
  }

  return await response.json();
}

// ì¿ í° ë°œê¸‰ í•¨ìˆ˜
async function issueCoupon(
  mallId: string,
  customerId: string,
  discountAmount: number
) {
  const mallSettings = await prisma.mallSettings.findUnique({
    where: { mallId }
  });

  if (!mallSettings) throw new Error('Mall settings not found');

  const url = `https://${mallId}.cafe24api.com/api/v2/admin/coupons`;
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${mallSettings.accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      request: {
        coupon_name: `Review2Earn ${discountAmount}ì› í• ì¸`,
        coupon_type: 'P',
        benefit_type: 'A',
        benefit_value: Math.round(discountAmount),
        available_begin_datetime: new Date().toISOString(),
        available_end_datetime: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
        issue_member_join_type: 'A',
        issue_member_ids: [customerId]
      }
    })
  });

  if (!response.ok) {
    throw new Error(`ì¿ í° ë°œê¸‰ ì‹¤íŒ¨: ${await response.text()}`);
  }

  return await response.json();
}
```
## 8. Phase 4 ê°œë°œ ê³„íš (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ)

### 8.1 ëª©í‘œ

- âœ… ì‹¤ì‹œê°„ í†µê³„ ëŒ€ì‹œë³´ë“œ
- âœ… ë³´ìƒ ë¹„ìœ¨ ì„¤ì • UI (ì‡¼í•‘ëª°/ì œí’ˆë³„)
- âœ… ë¦¬ë·° ë° ê±°ë˜ ë‚´ì—­ ì¡°íšŒ
- âœ… ë³´ìƒ ì§€ê¸‰ ë‚´ì—­ í™•ì¸
- âœ… Webhook ë¡œê·¸ ì¡°íšŒ

### 8.2 ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ êµ¬ì¡°

```
src/app/
â”œâ”€â”€ page.tsx                    # ë©”ì¸ ëŒ€ì‹œë³´ë“œ (OAuth + í†µê³„)
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ layout.tsx              # ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ
â”‚   â”œâ”€â”€ page.tsx                # í†µê³„ ëŒ€ì‹œë³´ë“œ
â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”œâ”€â”€ page.tsx            # ê¸°ë³¸ ì„¤ì •
â”‚   â”‚   â””â”€â”€ products/
â”‚   â”‚       â””â”€â”€ page.tsx        # ì œí’ˆë³„ ìš”ìœ¨ ì„¤ì •
â”‚   â”œâ”€â”€ reviews/
â”‚   â”‚   â””â”€â”€ page.tsx            # ë¦¬ë·° ë‚´ì—­
â”‚   â”œâ”€â”€ transactions/
â”‚   â”‚   â””â”€â”€ page.tsx            # ê±°ë˜ ë‚´ì—­
â”‚   â””â”€â”€ logs/
â”‚       â””â”€â”€ page.tsx            # Webhook ë¡œê·¸
```

### 8.3 í†µê³„ API

#### 8.3.1 ëŒ€ì‹œë³´ë“œ í†µê³„ API

**Endpoint:** `GET /api/dashboard/stats?mallId=review2earn`

**Response:**
```
{
  "success": true,
  "stats": {
    "totalReviews": 150,
    "r2eEnabledReviews": 80,
    "totalClicks": 1200,
    "totalConversions": 45,
    "conversionRate": 3.75,
    "totalRevenue": 4500000,
    "totalRewards": 45000,
    "totalDiscounts": 45000,
    "platformFees": 22500,
    "period": {
      "start": "2025-10-01",
      "end": "2025-10-08"
    }
  }
}
```

**êµ¬í˜„ ì½”ë“œ (ì˜ˆì •):**

```
// src/app/api/dashboard/stats/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const mallId = searchParams.get('mallId');
    const startDate = searchParams.get('start') || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
    const endDate = searchParams.get('end') || new Date().toISOString();

    if (!mallId) {
      return NextResponse.json(
        { success: false, message: 'Mall ID í•„ìš”' },
        { status: 400 }
      );
    }

    // 1. ì´ ë¦¬ë·° ìˆ˜
    const totalReviews = await prisma.review.count({
      where: {
        mallId,
        createdAt: {
          gte: new Date(startDate),
          lte: new Date(endDate)
        }
      }
    });

    // 2. R2E ì°¸ì—¬ ë¦¬ë·° ìˆ˜
    const r2eEnabledReviews = await prisma.review.count({
      where: {
        mallId,
        isR2EEnabled: true,
        createdAt: {
          gte: new Date(startDate),
          lte: new Date(endDate)
        }
      }
    });

    // 3. ì´ í´ë¦­ ìˆ˜
    const clicksSum = await prisma.referral.aggregate({
      where: {
        mallId,
        createdAt: {
          gte: new Date(startDate),
          lte: new Date(endDate)
        }
      },
      _sum: { clicks: true }
    });

    // 4. ì´ ì „í™˜ ìˆ˜
    const conversionsSum = await prisma.referral.aggregate({
      where: {
        mallId,
        createdAt: {
          gte: new Date(startDate),
          lte: new Date(endDate)
        }
      },
      _sum: { conversions: true }
    });

    // 5. ê±°ë˜ í†µê³„
    const transactionStats = await prisma.transaction.aggregate({
      where: {
        mallId,
        orderedAt: {
          gte: new Date(startDate),
          lte: new Date(endDate)
        }
      },
      _sum: {
        orderAmount: true,
        reviewerReward: true,
        buyerDiscount: true,
        platformFee: true
      }
    });

    const totalClicks = clicksSum._sum.clicks || 0;
    const totalConversions = conversionsSum._sum.conversions || 0;
    const conversionRate = totalClicks > 0 ? (totalConversions / totalClicks) * 100 : 0;

    return NextResponse.json({
      success: true,
      stats: {
        totalReviews,
        r2eEnabledReviews,
        totalClicks,
        totalConversions,
        conversionRate: parseFloat(conversionRate.toFixed(2)),
        totalRevenue: parseFloat(transactionStats._sum.orderAmount?.toString() || '0'),
        totalRewards: parseFloat(transactionStats._sum.reviewerReward?.toString() || '0'),
        totalDiscounts: parseFloat(transactionStats._sum.buyerDiscount?.toString() || '0'),
        platformFees: parseFloat(transactionStats._sum.platformFee?.toString() || '0'),
        period: {
          start: startDate,
          end: endDate
        }
      }
    });

  } catch (error) {
    console.error('Stats API ì˜¤ë¥˜:', error);
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜' },
      { status: 500 }
    );
  }
}
```

#### 8.3.2 ë³´ìƒ ë¹„ìœ¨ ì„¤ì • API

**Endpoint:** `PUT /api/settings/rewards`

**Request Body:**
```
{
  "mallId": "review2earn",
  "defaultRewardSettings": {
    "reviewerPercent": 1.5,
    "buyerPercent": 1.5
  }
}
```

**Response:**
```
{
  "success": true,
  "message": "ê¸°ë³¸ ë³´ìƒ ë¹„ìœ¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "settings": {
    "reviewerPercent": 1.5,
    "buyerPercent": 1.5,
    "platformPercent": 0.75
  }
}
```

#### 8.3.3 ì œí’ˆë³„ ë³´ìƒ ë¹„ìœ¨ ì„¤ì • API

**Endpoint:** `POST /api/settings/products`

**Request Body:**
```
{
  "mallId": "review2earn",
  "productId": "12345",
  "reviewerPercent": 3.0,
  "buyerPercent": 2.0
}
```

**Response:**
```
{
  "success": true,
  "message": "ì œí’ˆë³„ ë³´ìƒ ë¹„ìœ¨ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "productSettings": {
    "productId": "12345",
    "reviewerPercent": 3.0,
    "buyerPercent": 2.0,
    "platformPercent": 1.25
  }
}
```

---

## 9. API ëª…ì„¸ (ì™„ì „íŒ)

### 9.1 OAuth APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| POST | `/api/oauth/auth-url` | OAuth URL ìƒì„± | âœ… Phase 1 |
| GET | `/api/oauth/callback` | OAuth í† í° êµí™˜ | âœ… Phase 1 |
| POST | `/api/verify-token` | í† í° ê¶Œí•œ ê²€ì¦ | âœ… Phase 1 |
| GET | `/api/test-connection` | API ì—°ê²° í…ŒìŠ¤íŠ¸ | âœ… Phase 1 |

### 9.2 ScriptTags APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| POST | `/api/scripttags/install` | ScriptTag ì„¤ì¹˜ | âœ… Phase 1 |
| POST | `/api/scripttags/uninstall` | ScriptTag ì œê±° | âœ… Phase 1 |

### 9.3 Review APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| POST | `/api/consent` | ë¦¬ë·° ë™ì˜ ìˆ˜ì§‘ | ğŸ“‹ Phase 2 |
| GET | `/api/reviews/{reviewId}/button` | ë²„íŠ¼ ë°ì´í„° ì¡°íšŒ | ğŸ“‹ Phase 2 |
| GET | `/api/reviews?mallId={mallId}` | ë¦¬ë·° ëª©ë¡ ì¡°íšŒ | ğŸ“‹ Phase 4 |

### 9.4 Referral APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| GET | `/api/track?ref={code}` | ì¶”ì²œ ë§í¬ ì¶”ì  | ğŸ“‹ Phase 2 |
| GET | `/api/referrals?mallId={mallId}` | ì¶”ì²œ ë§í¬ ëª©ë¡ | ğŸ“‹ Phase 4 |

### 9.5 Webhook APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| POST | `/api/webhooks/order` | ì£¼ë¬¸ Webhook | ğŸ“‹ Phase 3 |
| POST | `/api/webhooks/review` | ë¦¬ë·° Webhook | ğŸ“‹ Phase 3 |

### 9.6 Dashboard APIs

| Method | Endpoint | ì„¤ëª… | Phase |
|--------|----------|------|-------|
| GET | `/api/dashboard/stats` | í†µê³„ ì¡°íšŒ | ğŸ“‹ Phase 4 |
| GET | `/api/transactions` | ê±°ë˜ ë‚´ì—­ | ğŸ“‹ Phase 4 |
| PUT | `/api/settings/rewards` | ê¸°ë³¸ ë³´ìƒ ì„¤ì • | ğŸ“‹ Phase 4 |
| POST | `/api/settings/products` | ì œí’ˆë³„ ë³´ìƒ ì„¤ì • | ğŸ“‹ Phase 4 |

---

## 10. ë³´ì•ˆ ë° ì„±ëŠ¥

### 10.1 ë³´ì•ˆ ì „ëµ

#### 10.1.1 OAuth í† í° ë³´ì•ˆ

**í˜„ì¬ (Phase 1):**
- PostgreSQLì— í‰ë¬¸ ì €ì¥
- HTTPSë¥¼ í†µí•œ ì „ì†¡ ë³´ì•ˆ

**í–¥í›„ ê°œì„  (Phase 2):**
```
// lib/encryption.ts
import crypto from 'crypto';

const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY!; // 32 bytes
const ALGORITHM = 'aes-256-gcm';

export function encrypt(text: string): string {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  return JSON.stringify({
    iv: iv.toString('hex'),
    encryptedData: encrypted,
    authTag: authTag.toString('hex')
  });
}

export function decrypt(encryptedJson: string): string {
  const { iv, encryptedData, authTag } = JSON.parse(encryptedJson);
  
  const decipher = crypto.createDecipheriv(
    ALGORITHM,
    Buffer.from(ENCRYPTION_KEY, 'hex'),
    Buffer.from(iv, 'hex')
  );
  
  decipher.setAuthTag(Buffer.from(authTag, 'hex'));
  
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}
```

#### 10.1.2 CSRF ë°©ì–´

**êµ¬í˜„ë¨ (Phase 1):**
- OAuth State ë§¤ê°œë³€ìˆ˜ì— íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨
- 10ë¶„ ìœ íš¨ ê¸°ê°„

**í–¥í›„ ê°œì„ :**
```
// lib/csrf.ts
import crypto from 'crypto';

export function generateCSRFToken(): string {
  return crypto.randomBytes(32).toString('hex');
}

export function validateCSRFToken(token: string, storedToken: string): boolean {
  return crypto.timingSafeEqual(
    Buffer.from(token),
    Buffer.from(storedToken)
  );
}
```

#### 10.1.3 Webhook ì„œëª… ê²€ì¦

**ì˜ˆì • (Phase 3):**
```
// lib/webhook-verify.ts
import crypto from 'crypto';

export function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

#### 10.1.4 Rate Limiting

**ì˜ˆì • (Phase 4):**
```
// middleware/rate-limit.ts
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(100, '1 h'), // 100 requests per hour
  analytics: true
});

export async function checkRateLimit(identifier: string) {
  const { success, limit, reset, remaining } = await ratelimit.limit(identifier);
  
  return {
    success,
    limit,
    reset,
    remaining
  };
}
```

### 10.2 ì„±ëŠ¥ ìµœì í™”

#### 10.2.1 ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤

**ì´ë¯¸ ì ìš©ëœ ì¸ë±ìŠ¤:**
```
// MallSettings
@@index([mallId])

// ProductSettings
@@index([mallId, productId])

// Reviews
@@index([mallId, reviewId])
@@index([mallId, productId])
@@index([customerId])

// Referrals
@@index([referralCode])
@@index([mallId, reviewId])
@@index([createdAt])

// Transactions
@@index([mallId, orderId])
@@index([referralId])
@@index([customerId])
@@index([rewardStatus])
@@index([orderedAt])

// WebhookLog
@@index([mallId, event])
@@index([processed])
@@index([createdAt])
```

#### 10.2.2 ìºì‹± ì „ëµ

**Redis ìºì‹± (ì˜ˆì •):**
```
// lib/cache.ts
import { Redis } from '@upstash/redis';

const redis = Redis.fromEnv();

export async function getCached<T>(key: string): Promise<T | null> {
  const cached = await redis.get<T>(key);
  return cached;
}

export async function setCached<T>(key: string, value: T, ttl: number = 3600): Promise<void> {
  await redis.set(key, value, { ex: ttl });
}

export async function invalidateCache(pattern: string): Promise<void> {
  const keys = await redis.keys(pattern);
  if (keys.length > 0) {
    await redis.del(...keys);
  }
}

// ì‚¬ìš© ì˜ˆì‹œ
async function getRewardRates(mallId: string, productId: string) {
  const cacheKey = `reward-rates:${mallId}:${productId}`;
  
  // ìºì‹œ í™•ì¸
  const cached = await getCached(cacheKey);
  if (cached) return cached;
  
  // DB ì¡°íšŒ
  const rates = await fetchRewardRatesFromDB(mallId, productId);
  
  // ìºì‹œ ì €ì¥ (1ì‹œê°„)
  await setCached(cacheKey, rates, 3600);
  
  return rates;
}
```

#### 10.2.3 API ì‘ë‹µ ì••ì¶•

**Next.js ìë™ ì••ì¶• í™œì„±í™”:**
```
// next.config.js
module.exports = {
  compress: true,
  // ...
};
```

#### 10.2.4 Connection Pooling

**Prisma Connection Pool ì„¤ì •:**
```
# .env
DATABASE_URL="postgresql://user:password@localhost:5432/review2earn?connection_limit=10&pool_timeout=20"
```

---

## 11. ë°°í¬ ë° ìš´ì˜

### 11.1 ë°°í¬ í™˜ê²½

| í™˜ê²½ | URL | Branch | ìš©ë„ |
|------|-----|--------|------|
| Production | https://review2earn.vercel.app | main | ì‹¤ì œ ì„œë¹„ìŠ¤ |
| Staging | https://review2earn-staging.vercel.app | develop | í…ŒìŠ¤íŠ¸ |
| Development | http://localhost:3000 | feature/* | ë¡œì»¬ ê°œë°œ |

### 11.2 í™˜ê²½ ë³€ìˆ˜

```
# .env.local (ë¡œì»¬ ê°œë°œ)
# .env.production (Vercel í”„ë¡œë•ì…˜)

# Database
POSTGRES_PRISMA_URL="postgresql://..."
POSTGRES_URL_NON_POOLING="postgresql://..."

# Cafe24 OAuth
CAFE24_CLIENT_ID="WYht5QinOtql2mDJe0hVvA"
CAFE24_CLIENT_SECRET="xxxxxxxxxxxxx"
CAFE24_REDIRECT_URI="https://review2earn.vercel.app/api/oauth/callback"

# Next.js
NEXT_PUBLIC_BASE_URL="https://review2earn.vercel.app"

# Security (Phase 2)
ENCRYPTION_KEY="64ìë¦¬ hex í‚¤"
WEBHOOK_SECRET="ì¹´í˜24ì—ì„œ ì œê³µ"

# Redis (Phase 4)
UPSTASH_REDIS_REST_URL="https://..."
UPSTASH_REDIS_REST_TOKEN="..."
```

### 11.3 ë°°í¬ í”„ë¡œì„¸ìŠ¤

#### 11.3.1 ìë™ ë°°í¬ (Git Push)

```
# 1. ê°œë°œ ì™„ë£Œ
git add .
git commit -m "feat: ì¶”ì²œ ë§í¬ ìƒì„± ê¸°ëŠ¥ ì¶”ê°€"

# 2. Push
git push origin main

# 3. Vercel ìë™ ë°°í¬ (1-2ë¶„)
# â†’ GitHub Webhook â†’ Vercel Build â†’ Deploy
```

#### 11.3.2 ìˆ˜ë™ ë°°í¬ (Vercel CLI)

```
# í”„ë¡œë•ì…˜ ë°°í¬
vercel --prod

# í”„ë¦¬ë·° ë°°í¬
vercel
```

### 11.4 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

```
# 1. ë¡œì»¬ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
npx prisma migrate dev --name add_product_settings

# 2. Gitì— ì»¤ë°‹
git add prisma/migrations
git commit -m "db: ì œí’ˆë³„ ë³´ìƒ ì„¤ì • í…Œì´ë¸” ì¶”ê°€"
git push

# 3. Vercelì—ì„œ ìë™ ì‹¤í–‰
# vercel.jsonì— build ëª…ë ¹ í¬í•¨:
{
  "buildCommand": "prisma generate && prisma migrate deploy && next build"
}
```

### 11.5 ëª¨ë‹ˆí„°ë§

#### 11.5.1 Vercel Analytics

- ìë™ í™œì„±í™” (Vercel ëŒ€ì‹œë³´ë“œ)
- í˜ì´ì§€ ë¡œë“œ ì‹œê°„
- API ì‘ë‹µ ì‹œê°„
- ì—ëŸ¬ìœ¨

#### 11.5.2 ë¡œê·¸ ëª¨ë‹ˆí„°ë§

```
# Vercel CLIë¡œ ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
vercel logs --follow

# íŠ¹ì • í•¨ìˆ˜ ë¡œê·¸
vercel logs /api/webhooks/order
```

#### 11.5.3 ì—ëŸ¬ íŠ¸ë˜í‚¹ (Sentry - ì„ íƒ)

```
// lib/sentry.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV
});
```

## 12. ê°œë°œ ì¼ì • ë° ë§ˆì¼ìŠ¤í†¤

### 12.1 Phase 1: OAuth + ScriptTags âœ… ì™„ë£Œ

**ê¸°ê°„:** 2025.10.01 ~ 2025.10.08 (1ì£¼)

| ì‘ì—… | ìƒíƒœ | ì™„ë£Œì¼ |
|------|------|--------|
| ì¹´í˜24 OAuth 2.0 ì¸ì¦ êµ¬í˜„ | âœ… | 2025.10.03 |
| Access Token DB ì €ì¥ | âœ… | 2025.10.05 |
| ScriptTags API í†µí•© | âœ… | 2025.10.06 |
| ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (ê¸°ë³¸) | âœ… | 2025.10.07 |
| Vercel ë°°í¬ | âœ… | 2025.10.08 |

**ì£¼ìš” ì„±ê³¼:**
- âœ… OAuth ì™„ì „ ìë™í™”
- âœ… ì›í´ë¦­ ScriptTag ì„¤ì¹˜/ì œê±°
- âœ… PostgreSQL í† í° ì €ì¥
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ì™„ë£Œ

---

### 12.2 Phase 2: ë¦¬ë·° ë™ì˜ + ì¶”ì²œ ë§í¬ ğŸ“‹ ê³„íš

**ëª©í‘œ ê¸°ê°„:** 2025.10.09 ~ 2025.10.20 (2ì£¼)

| ì‘ì—… | ìš°ì„ ìˆœìœ„ | ì˜ˆìƒ ê¸°ê°„ |
|------|----------|-----------|
| ë¦¬ë·° ë™ì˜ API êµ¬í˜„ | ğŸ”¥ ë†’ìŒ | 2ì¼ |
| ì¶”ì²œ ì½”ë“œ ìƒì„± ë¡œì§ | ğŸ”¥ ë†’ìŒ | 1ì¼ |
| ì¶”ì²œ ë§í¬ ì¶”ì  API | ğŸ”¥ ë†’ìŒ | 2ì¼ |
| review-consent.js ìŠ¤í¬ë¦½íŠ¸ | ğŸ”¥ ë†’ìŒ | 3ì¼ |
| ë¦¬ë·° ë²„íŠ¼ í‘œì‹œ ìŠ¤í¬ë¦½íŠ¸ | ğŸ”¶ ì¤‘ê°„ | 3ì¼ |
| í´ë¦­ í†µê³„ ìˆ˜ì§‘ | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… | ğŸ”¥ ë†’ìŒ | 2ì¼ |

**ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- [ ] POST /api/consent êµ¬í˜„
- [ ] GET /api/track êµ¬í˜„
- [ ] GET /api/reviews/{id}/button êµ¬í˜„
- [ ] review-consent.js ì™„ì„±
- [ ] review-button.js ì™„ì„±
- [ ] Referrals í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] ì¹´í˜24 í…ŒìŠ¤íŠ¸ ìŠ¤í† ì–´ì—ì„œ E2E í…ŒìŠ¤íŠ¸

---

### 12.3 Phase 3: ì£¼ë¬¸ ì¶”ì  + ìë™ ë³´ìƒ ğŸ“‹ ê³„íš

**ëª©í‘œ ê¸°ê°„:** 2025.10.21 ~ 2025.11.05 (2ì£¼)

| ì‘ì—… | ìš°ì„ ìˆœìœ„ | ì˜ˆìƒ ê¸°ê°„ |
|------|----------|-----------|
| ì£¼ë¬¸ Webhook êµ¬í˜„ | ğŸ”¥ ë†’ìŒ | 3ì¼ |
| ë³´ìƒ ê³„ì‚° ë¡œì§ | ğŸ”¥ ë†’ìŒ | 2ì¼ |
| ì ë¦½ê¸ˆ ì§€ê¸‰ API ì—°ë™ | ğŸ”¥ ë†’ìŒ | 2ì¼ |
| ì¿ í° ë°œê¸‰ API ì—°ë™ | ğŸ”¥ ë†’ìŒ | 2ì¼ |
| ì œí’ˆë³„ ë³´ìƒ ì„¤ì • | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| Webhook ì¬ì‹œë„ ë¡œì§ | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… | ğŸ”¥ ë†’ìŒ | 2ì¼ |

**ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- [ ] POST /api/webhooks/order êµ¬í˜„
- [ ] ë³´ìƒ ë¹„ìœ¨ ìš°ì„ ìˆœìœ„ ë¡œì§ (ì œí’ˆë³„ > ì‡¼í•‘ëª° > ê¸°ë³¸ê°’)
- [ ] grantMileage() í•¨ìˆ˜
- [ ] issueCoupon() í•¨ìˆ˜
- [ ] Transactions í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] ProductSettings í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] Webhook ì„œëª… ê²€ì¦
- [ ] ì‹¤ì œ ì£¼ë¬¸ìœ¼ë¡œ E2E í…ŒìŠ¤íŠ¸

---

### 12.4 Phase 4: ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ğŸ“‹ ê³„íš

**ëª©í‘œ ê¸°ê°„:** 2025.11.06 ~ 2025.11.20 (2ì£¼)

| ì‘ì—… | ìš°ì„ ìˆœìœ„ | ì˜ˆìƒ ê¸°ê°„ |
|------|----------|-----------|
| í†µê³„ ëŒ€ì‹œë³´ë“œ UI | ğŸ”¥ ë†’ìŒ | 3ì¼ |
| ë³´ìƒ ì„¤ì • UI | ğŸ”¥ ë†’ìŒ | 3ì¼ |
| ë¦¬ë·° ë‚´ì—­ ì¡°íšŒ | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| ê±°ë˜ ë‚´ì—­ ì¡°íšŒ | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| Webhook ë¡œê·¸ ì¡°íšŒ | ğŸ”µ ë‚®ìŒ | 1ì¼ |
| ì°¨íŠ¸ ì‹œê°í™” | ğŸ”¶ ì¤‘ê°„ | 2ì¼ |
| í…ŒìŠ¤íŠ¸ ë° ë””ë²„ê¹… | ğŸ”¥ ë†’ìŒ | 2ì¼ |

**ì²´í¬ë¦¬ìŠ¤íŠ¸:**
- [ ] /dashboard í˜ì´ì§€
- [ ] GET /api/dashboard/stats êµ¬í˜„
- [ ] PUT /api/settings/rewards êµ¬í˜„
- [ ] POST /api/settings/products êµ¬í˜„
- [ ] Chart.js ë˜ëŠ” Recharts í†µí•©
- [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸
- [ ] UX í…ŒìŠ¤íŠ¸

---

### 12.5 ì „ì²´ íƒ€ì„ë¼ì¸

```
2025ë…„ 10ì›”                              2025ë…„ 11ì›”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Week 1 â”‚ Week 2 â”‚ Week 3 â”‚ Week 4 â”‚ Week 1 â”‚ Week 2 â”‚ Week 3 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… P1  â”‚ âœ… P1  â”‚ ğŸ“‹ P2  â”‚ ğŸ“‹ P2  â”‚ ğŸ“‹ P3  â”‚ ğŸ“‹ P3  â”‚ ğŸ“‹ P4  â”‚
â”‚ OAuth  â”‚ Script â”‚ Review â”‚ Refer  â”‚ Webhookâ”‚ Reward â”‚ Admin  â”‚
â”‚        â”‚ Tags   â”‚ Consentâ”‚ Track  â”‚        â”‚        â”‚ Panel  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ì™„ë£Œ    ğŸ“‹ ì˜ˆì •
```

---

## 13. í…ŒìŠ¤íŠ¸ ì „ëµ

### 13.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Unit Tests)

**í”„ë ˆì„ì›Œí¬:** Jest + React Testing Library

```
// __tests__/lib/reward-calculator.test.ts
import { calculateRewards } from '@/lib/reward-calculator';

describe('calculateRewards', () => {
  it('should calculate rewards with default rates (1%, 1%)', () => {
    const result = calculateRewards(100000, 1.0, 1.0);
    
    expect(result.reviewerReward).toBe(1000);
    expect(result.buyerDiscount).toBe(1000);
    expect(result.platformFee).toBe(500);
    expect(result.total).toBe(2500);
  });

  it('should calculate rewards with custom rates (3%, 2%)', () => {
    const result = calculateRewards(500000, 3.0, 2.0);
    
    expect(result.reviewerReward).toBe(15000);
    expect(result.buyerDiscount).toBe(10000);
    expect(result.platformFee).toBe(6250); // (3+2)*0.25% = 1.25%
    expect(result.total).toBe(31250);
  });
});
```

**ì‹¤í–‰:**
```
npm test
```

### 13.2 í†µí•© í…ŒìŠ¤íŠ¸ (Integration Tests)

**í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:**

1. **OAuth í”Œë¡œìš°**
   - Mall ID ì…ë ¥ â†’ OAuth URL ìƒì„±
   - ì¹´í˜24 ë™ì˜ â†’ Callback ì²˜ë¦¬
   - DBì— í† í° ì €ì¥ í™•ì¸

2. **ScriptTags ì„¤ì¹˜**
   - ì„¤ì¹˜ API í˜¸ì¶œ
   - ì¹´í˜24ì—ì„œ ScriptTag í™•ì¸
   - ì¤‘ë³µ ì„¤ì¹˜ ë°©ì§€ í™•ì¸

3. **ë¦¬ë·° ë™ì˜ í”Œë¡œìš° (Phase 2)**
   - ë™ì˜ ì²´í¬ â†’ API í˜¸ì¶œ
   - Referral ìƒì„± í™•ì¸
   - ì¶”ì²œ ë§í¬ ìœ íš¨ì„±

4. **ì£¼ë¬¸ â†’ ë³´ìƒ í”Œë¡œìš° (Phase 3)**
   - ì¶”ì²œ ë§í¬ í´ë¦­ â†’ ì¿ í‚¤ ì €ì¥
   - ì£¼ë¬¸ ì™„ë£Œ â†’ Webhook ìˆ˜ì‹ 
   - ë³´ìƒ ê³„ì‚° â†’ ì ë¦½ê¸ˆ/ì¿ í° ì§€ê¸‰

### 13.3 E2E í…ŒìŠ¤íŠ¸ (End-to-End)

**ë„êµ¬:** Playwright ë˜ëŠ” Cypress

```
// e2e/oauth-flow.spec.ts
import { test, expect } from '@playwright/test';

test('OAuth ì¸ì¦ í”Œë¡œìš°', async ({ page }) => {
  // 1. ë©”ì¸ í˜ì´ì§€ ì ‘ì†
  await page.goto('https://review2earn.vercel.app');
  
  // 2. Mall ID ì…ë ¥
  await page.fill('input[name="mallId"]', 'review2earn');
  await page.click('button:has-text("OAuth ì¸ì¦ ì‹œì‘")');
  
  // 3. OAuth URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í™•ì¸
  await expect(page).toHaveURL(/cafe24\.com\/api\/v2\/oauth\/authorize/);
  
  // 4. ì¹´í˜24 ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ ê³„ì •)
  await page.fill('input[name="username"]', 'testuser');
  await page.fill('input[name="password"]', 'testpass');
  await page.click('button[type="submit"]');
  
  // 5. ë™ì˜ ë²„íŠ¼ í´ë¦­
  await page.click('button:has-text("ë™ì˜")');
  
  // 6. Callback í›„ ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  await expect(page).toHaveURL(/\?oauth_success=true/);
  
  // 7. ì„±ê³µ ë©”ì‹œì§€ í™•ì¸
  await expect(page.locator('text=OAuth ì¸ì¦ ì™„ë£Œ')).toBeVisible();
});
```

### 13.4 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

**ë„êµ¬:** k6

```
// load-test/webhook.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '1m', target: 10 },
    { duration: '3m', target: 50 },
    { duration: '1m', target: 0 },
  ],
};

export default function () {
  const payload = JSON.stringify({
    resource: {
      mall_id: 'review2earn',
      order_id: `TEST-${Date.now()}`,
      items: [{ product_no: 12345, product_price: '100000' }]
    }
  });

  const res = http.post('https://review2earn.vercel.app/api/webhooks/order', payload, {
    headers: { 'Content-Type': 'application/json' },
  });

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);
}
```

---

## 14. íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

### 14.1 OAuth ê´€ë ¨ ì˜¤ë¥˜

#### ë¬¸ì œ: "í† í° êµí™˜ ì‹¤íŒ¨"

**ì¦ìƒ:**
```
OAuth Callback ì˜¤ë¥˜: í† í° êµí™˜ ì‹¤íŒ¨
```

**ì›ì¸:**
1. Client Secret ë¶ˆì¼ì¹˜
2. Redirect URI ë¶ˆì¼ì¹˜
3. Authorization Code ë§Œë£Œ (10ë¶„)

**í•´ê²°:**
```
# 1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸
echo $CAFE24_CLIENT_SECRET
echo $CAFE24_REDIRECT_URI

# 2. ì¹´í˜24 ê°œë°œì ì„¼í„°ì—ì„œ í™•ì¸
# https://developers.cafe24.com/app/my

# 3. Vercel í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
vercel env pull
```

#### ë¬¸ì œ: "Access Token ë§Œë£Œ"

**ì¦ìƒ:**
```
Cafe24 API ì˜¤ë¥˜: 401 Unauthorized
```

**í•´ê²°:**
```
// lib/cafe24-api.ts
async function refreshAccessToken(mallId: string) {
  const settings = await prisma.mallSettings.findUnique({
    where: { mallId }
  });

  if (!settings?.refreshToken) {
    throw new Error('Refresh token not found');
  }

  const response = await fetch(`https://${mallId}.cafe24api.com/api/v2/oauth/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: settings.refreshToken,
      client_id: process.env.CAFE24_CLIENT_ID!,
      client_secret: process.env.CAFE24_CLIENT_SECRET!
    })
  });

  const data = await response.json();

  // DB ì—…ë°ì´íŠ¸
  await prisma.mallSettings.update({
    where: { mallId },
    data: {
      accessToken: data.access_token,
      expiresAt: new Date(Date.now() + data.expires_in * 1000)
    }
  });

  return data.access_token;
}
```

---

### 14.2 ScriptTags ê´€ë ¨ ì˜¤ë¥˜

#### ë¬¸ì œ: "ScriptTagê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"

**ì¦ìƒ:**
- ë¦¬ë·° ì‘ì„± í˜ì´ì§€ì— ì²´í¬ë°•ìŠ¤ ì—†ìŒ

**ì›ì¸:**
1. display_location ì„¤ì • ì˜¤ë¥˜
2. ìŠ¤í¬ë¦½íŠ¸ URL ì˜¤ë¥˜
3. ìºì‹œ ë¬¸ì œ

**í•´ê²°:**
```
# 1. ì¹´í˜24 ê´€ë¦¬ìì—ì„œ ScriptTag í™•ì¸
# ì‡¼í•‘ëª° ê´€ë¦¬ â†’ ì•± â†’ Review2Earn â†’ ì„¤ì •

# 2. ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ
Ctrl + Shift + R (ê°•ë ¥ ìƒˆë¡œê³ ì¹¨)

# 3. ìŠ¤í¬ë¦½íŠ¸ URL ì§ì ‘ ì ‘ì†
https://review2earn.vercel.app/scripts/review-consent.js

# 4. ì½˜ì†”ì—ì„œ ì—ëŸ¬ í™•ì¸
F12 â†’ Console íƒ­
```

---

### 14.3 Webhook ê´€ë ¨ ì˜¤ë¥˜

#### ë¬¸ì œ: "Webhookì´ ìˆ˜ì‹ ë˜ì§€ ì•ŠìŒ"

**ì¦ìƒ:**
- ì£¼ë¬¸ ì™„ë£Œí•´ë„ ë³´ìƒ ì§€ê¸‰ ì•ˆë¨

**ì›ì¸:**
1. Webhook URL ë¯¸ë“±ë¡
2. ì„œë²„ ì˜¤ë¥˜ë¡œ 500 ì‘ë‹µ
3. íƒ€ì„ì•„ì›ƒ

**í•´ê²°:**
```
# 1. Webhook ë¡œê·¸ í™•ì¸
SELECT * FROM webhook_logs 
WHERE mall_id = 'review2earn' 
ORDER BY created_at DESC 
LIMIT 10;

# 2. Vercel í•¨ìˆ˜ ë¡œê·¸ í™•ì¸
vercel logs /api/webhooks/order --follow

# 3. Webhook ì¬ì „ì†¡ (ì¹´í˜24 ê´€ë¦¬ì)
ì‡¼í•‘ëª° ê´€ë¦¬ â†’ ê°œë°œì ë„êµ¬ â†’ Webhook â†’ ì¬ì „ì†¡
```

---

### 14.4 ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì˜¤ë¥˜

#### ë¬¸ì œ: "Prisma Client ìƒì„± ì˜¤ë¥˜"

**ì¦ìƒ:**
```
Error: Cannot find module '@prisma/client'
```

**í•´ê²°:**
```
# 1. Prisma Client ì¬ìƒì„±
npx prisma generate

# 2. ì˜ì¡´ì„± ì¬ì„¤ì¹˜
rm -rf node_modules
npm install

# 3. ë§ˆì´ê·¸ë ˆì´ì…˜ ë™ê¸°í™”
npx prisma migrate deploy
```

---

## 15. FAQ (ìì£¼ ë¬»ëŠ” ì§ˆë¬¸)

### Q1. ì¹´í˜24 ì™¸ ë‹¤ë¥¸ í”Œë«í¼ë„ ì§€ì›í•˜ë‚˜ìš”?

**A:** í˜„ì¬ëŠ” ì¹´í˜24ë§Œ ì§€ì›í•©ë‹ˆë‹¤. í–¥í›„ Shopify, WooCommerce ì§€ì› ì˜ˆì •ì…ë‹ˆë‹¤.

**ë¡œë“œë§µ:**
- âœ… Phase 1-4: ì¹´í˜24 ì™„ì„±
- ğŸ“‹ Phase 5: Shopify í†µí•©
- ğŸ“‹ Phase 6: WooCommerce í†µí•©

---

### Q2. ë³´ìƒ ë¹„ìœ¨ì€ ì–¼ë§ˆê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•œê°€ìš”?

**A:** ìµœì†Œ 1%ë¶€í„° ì œí•œ ì—†ìŠµë‹ˆë‹¤.

**ê¶Œì¥ ë¹„ìœ¨:**
- **ì €ê°€ ì œí’ˆ (1ë§Œì› ì´í•˜):** 1% / 1%
- **ì¤‘ê°€ ì œí’ˆ (1ë§Œ~10ë§Œì›):** 2% / 2%
- **ê³ ê°€ ì œí’ˆ (10ë§Œì› ì´ìƒ):** 3% / 3%
- **ëŸ­ì…”ë¦¬ ì œí’ˆ (100ë§Œì› ì´ìƒ):** 5% / 5%

---

### Q3. ì ë¦½ê¸ˆì´ ìë™ìœ¼ë¡œ ì§€ê¸‰ ì•ˆ ë¼ìš”.

**A:** ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

1. **OAuth ê¶Œí•œ í™•ì¸**
   - `mall.write_customer` ê¶Œí•œ í•„ìš”
   - ì¹´í˜24 ê°œë°œì ì„¼í„°ì—ì„œ í™•ì¸

2. **Webhook ë“±ë¡ í™•ì¸**
   - `order/confirm` ì´ë²¤íŠ¸ ë“±ë¡
   - URL: `https://review2earn.vercel.app/api/webhooks/order`

3. **Transaction ìƒíƒœ í™•ì¸**
   ```
   SELECT * FROM transactions 
   WHERE mall_id = 'your_mall_id' 
   AND reward_status = 'failed';
   ```

---

### Q4. í”Œë«í¼ ìˆ˜ìˆ˜ë£ŒëŠ” ì–¸ì œ ì²­êµ¬ë˜ë‚˜ìš”?

**A:** ì›”ë§ ì •ì‚°ì…ë‹ˆë‹¤.

**ì²­êµ¬ í”„ë¡œì„¸ìŠ¤:**
1. ë§¤ì›” 1ì¼: ì „ì›” ê±°ë˜ ì§‘ê³„
2. ë§¤ì›” 5ì¼: ì²­êµ¬ì„œ ë°œí–‰
3. ë§¤ì›” 10ì¼: ê²°ì œ (ìë™ ì´ì²´)

**ê³„ì‚° ê³µì‹:**
```
ì›” í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ = Î£(ê±°ë˜ë³„ platformFee)
```

---

### Q5. ë¦¬ë·° ì‘ì„±ìê°€ ë³¸ì¸ ì¶”ì²œ ë§í¬ë¡œ êµ¬ë§¤í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?

**A:** ìê°€ ì¶”ì²œì€ ë°©ì§€ë©ë‹ˆë‹¤.

**ë¡œì§:**
```
// Phase 3ì—ì„œ êµ¬í˜„ ì˜ˆì •
if (order.customerId === referral.review.customerId) {
  console.log('ìê°€ ì¶”ì²œ ê°ì§€ - ë³´ìƒ ì§€ê¸‰ ì•ˆí•¨');
  return;
}
```

---

## 16. ì°¸ê³  ë¬¸ì„œ

### 16.1 ë‚´ë¶€ ë¬¸ì„œ

- [v3.0 ì„¤ê³„ ë¬¸ì„œ] Review2Earn (ë¦¬ë·°íˆ¬ì–¸) - ìµœì¢… ì„¤ê³„ ë¬¸ì„œ.md
- [ê°œë°œ ì™„ë£Œ ë³´ê³ ì„œ] ë¦¬ë·°íˆ¬ì–¸(Review2Earn) ì¹´í˜24 ì•± ê°œë°œ ì™„ë£Œ ë³´ê³ ì„œ.md
- [í”„ë¡œí† íƒ€ì… ë³´ê³ ì„œ] ë¦¬ë·°íˆ¬ì–¸(Review2Earn) í”„ë¡œí† íƒ€ì… ê°œë°œ ì™„ë£Œ ë³´ê³ ì„œ.docx

### 16.2 ì¹´í˜24 ê³µì‹ ë¬¸ì„œ

- [OAuth ê°€ì´ë“œ] Cafe24_manual_01.pdf
- [API ì‚¬ìš© ê°€ì´ë“œ] Cafe24_manual_02.pdf
- [Webhook ê°€ì´ë“œ] Cafe24_manual_03.pdf
- [ê°œë°œì ì„¼í„°] https://developers.cafe24.com

### 16.3 ê¸°ìˆ  ìŠ¤íƒ ë¬¸ì„œ

- [Next.js 15] https://nextjs.org/docs
- [Prisma ORM] https://www.prisma.io/docs
- [Vercel ë°°í¬] https://vercel.com/docs

---

## 17. ë²„ì „ íˆìŠ¤í† ë¦¬

| ë²„ì „ | ë‚ ì§œ | ì£¼ìš” ë³€ê²½ì‚¬í•­ |
|------|------|---------------|
| v4.0 | 2025.10.08 | Phase 1 ì™„ë£Œ ë°˜ì˜, ì „ì²´ ì¬êµ¬ì„± |
| v3.0 | 2025.10.07 | ì œí’ˆë³„ ë³´ìƒ ë¹„ìœ¨ ì‹œìŠ¤í…œ ì¶”ê°€ |
| v2.0 | 2025.10.07 | ìµœì´ˆ ì„¤ê³„ ë¬¸ì„œ ì‘ì„± |
| v1.0 | 2025.10.05 | í”„ë¡œí† íƒ€ì… ê¸°íš |

---

## 18. ë¼ì´ì„ ìŠ¤

**Proprietary License**

Copyright (c) 2025 Review2Earn (parktaejun)

ì´ ì†Œí”„íŠ¸ì›¨ì–´ ë° ê´€ë ¨ ë¬¸ì„œëŠ” ì €ì‘ê¶Œë²•ì˜ ë³´í˜¸ë¥¼ ë°›ìŠµë‹ˆë‹¤.  
ë¬´ë‹¨ ë³µì œ, ë°°í¬, ìˆ˜ì •ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.

---

## 19. ì—°ë½ì²˜

**ê°œë°œì:**
- Name: Park Taejun
- Email: parktaejun@gmail.com
- GitHub: https://github.com/parktaejun/review2earn

**ì§€ì›:**
- Documentation: https://review2earn.vercel.app/docs
- Issues: https://github.com/parktaejun/review2earn/issues

---

**ğŸ‰ Review2Earn v4.0 ì„¤ê³„ ë¬¸ì„œ ì™„ë£Œ!**

**ë‹¤ìŒ ë‹¨ê³„:**
1. Phase 2 ì°©ìˆ˜ (ë¦¬ë·° ë™ì˜ + ì¶”ì²œ ë§í¬)
2. ì£¼ê°„ ê°œë°œ íšŒì˜ (ë§¤ì£¼ ì›”ìš”ì¼)
3. ì›”ê°„ ë¦¬ë·° (ë§¤ì›” ë§ì¼)

**Happy Coding! ğŸš€**
```

